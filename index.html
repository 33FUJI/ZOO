<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>33æ—¥æœ¬å‹•ç‰©åœ’ | ä»£è³¼ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        :root{--bg:#f8f9fa;--blue:#003399;--red:#d9534f;--gold:#b5a491;--gray:#666}
        body{font-family:sans-serif;background:var(--bg);margin:0;padding-bottom:200px;color:#333}
        
        /* é é¦– */
        header{padding:15px;text-align:center;font-weight:bold;color:var(--gold);font-size:1.4em;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
        .deadline-banner { background: #fff5f5; color: var(--red); text-align: center; padding: 8px; font-size: 0.9em; font-weight: bold; border-bottom: 1px solid #ffebeb; }

        /* æš±ç¨±å€ */
        .top-section{padding:15px;background:#fff;margin-bottom:10px}
        .nick-input{width:100%;padding:12px;border-radius:10px;border:2px solid #eee;box-sizing:border-box;font-size:16px;outline:none}
        .nick-input:focus{border-color:var(--gold)}

        /* åˆ†é¡ç¶²æ ¼ */
        .cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:10px 15px}
        .cat-card{background:#fff;padding:25px 10px;border-radius:15px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.05);cursor:pointer;border:1px solid #eee;font-weight:bold}

        /* å½ˆçª—ä½ˆå±€ï¼šå·¦å•†å“è³‡è¨Šã€å³å´åŠ æ¸› */
        .modal{position:fixed;inset:0;background:var(--bg);z-index:9999;display:none;flex-direction:column}
        .modal-header{padding:15px;background:#fff;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee}
        .p-group{background:#fff;margin:10px 15px;border-radius:12px;overflow:hidden;border:1px solid #eee}
        .p-header{padding:12px 15px;font-weight:bold;background:#fafafa;display:flex;align-items:center;gap:10px}
        .p-img{width:50px;height:50px;border-radius:5px;object-fit:cover;background:#eee}
        
        .spec-item{display:flex;justify-content:space-between;align-items:center;padding:15px;border-top:1px solid #f9f9f9}
        .spec-info{flex:1;font-size:0.95em}
        .qty-controls{display:flex;align-items:center;gap:12px;margin-left:15px}
        .qty-btn{width:32px;height:32px;border-radius:50%;border:1px solid #ddd;background:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}

        /* åº•éƒ¨è³¼ç‰©è»Šèˆ‡ç·¨è¼¯æŠ½å±œ */
        .order-area{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:15px 20px 25px;border-radius:20px 20px 0 0;box-shadow:0 -5px 25px rgba(0,0,0,0.1);z-index:10000}
        #cart-drawer{display:none;max-height:350px;overflow-y:auto;margin-bottom:15px;padding-top:10px;border-top:1px solid #eee}
        .drawer-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .submit-btn{width:100%;padding:15px;border-radius:12px;border:none;background:var(--blue);color:#fff;font-weight:bold;font-size:1.1em;margin-top:10px}

        /* ç®¡ç†å“¡ */
        .admin-box{padding:15px;background:#fff;margin:10px;border-radius:10px;border:1px solid #ddd;font-size:0.9em}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{border:1px solid #eee;padding:8px;text-align:left}
    </style>
</head>
<body>

<header>âœ¨ 33æ—¥æœ¬å‹•ç‰©åœ’ âœ¨</header>
<div class="deadline-banner" id="deadline-text">â³ æœ¬åœ˜é è¨ˆ 2024/05/20 23:59 çµå–®</div>

<div class="top-section">
    <input type="text" id="user-nick" class="nick-input" placeholder="âœ è«‹è¼¸å…¥æ‚¨çš„æš±ç¨± (ä¾‹å¦‚ï¼šç‹å°æ˜)">
    <div style="display:flex; justify-content:space-between; margin-top:12px; align-items:center;">
        <button onclick="fetchHistory()" style="background:none; border:none; color:var(--blue); text-decoration:underline; font-size:0.85em;">ğŸ” æŸ¥è©¢æˆ‘çš„æ­·å²ç™»è¨˜</button>
        <button id="admin-trigger" onclick="toggleAdmin()" style="display:none; background:var(--gold); border:none; color:white; padding:8px 15px; border-radius:5px; font-weight:bold;">ç®¡ç†å“¡æ¨¡å¼</button>
    </div>
</div>

<div class="cat-grid" id="main-grid"></div>

<div id="admin-area" style="display:none">
    <div class="admin-box">
        <h3>æ–°å¢ä»£è³¼å•†å“</h3>
        <input id="ad-cat" style="width:48%" placeholder="åˆ†é¡(å¦‚:æ¼”å”±æœƒ)">
        <input id="ad-img" style="width:48%" placeholder="åœ–ç‰‡ç¶²å€(é¸å¡«)">
        <input id="ad-name" style="width:100%; margin:5px 0" placeholder="å•†å“åç¨±">
        <input id="ad-price" style="width:48%" type="number" placeholder="å–®åƒ¹">
        <input id="ad-spec" style="width:48%" placeholder="è¦æ ¼(ç”¨,éš”é–‹)">
        <button onclick="saveProduct()" style="width:100%; margin-top:10px; background:#28a745; color:#fff; border:none; padding:10px">ä¸Šæ¶å•†å“</button>
    </div>
    <div class="admin-box">
        <h3>è¨‚å–®ç¸½è¦½ <button onclick="exportExcel()" style="background:var(--blue); color:white; font-size:0.7em">åŒ¯å‡º Excel</button></h3>
        <div id="order-table" style="overflow-x:auto;"></div>
    </div>
</div>

<div id="item-modal" class="modal">
    <div class="modal-header">
        <span onclick="closeModal()" style="cursor:pointer; font-weight:bold; color:var(--blue);">â® è¿”å›</span>
        <h2 id="cat-title" style="font-size:1em; margin:0"></h2>
        <span></span>
    </div>
    <div id="p-list" style="overflow-y:auto; flex:1"></div>
</div>

<div class="order-area" id="order-bar" style="display:none">
    <div id="cart-drawer">
        <div style="font-size:0.8em; color:var(--gray); margin-bottom:10px;">æ‚¨å¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹èª¿æ•´æ•¸é‡æˆ–å–æ¶ˆ</div>
        <div id="cart-items-list"></div>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div onclick="toggleDrawer()" style="cursor:pointer; color:var(--blue); font-weight:bold; font-size:0.9em;">
            ğŸ›’ æŸ¥çœ‹/ç·¨è¼¯æ¸…å–® (<span id="cart-count">0</span>)
        </div>
        <div style="text-align:right">
            <div style="font-size:0.7em; color:var(--gray)">ä¼°è¨ˆé‡‘é¡</div>
            <div style="color:var(--red); font-size:1.4em; font-weight:bold;">$<span id="total-val">0</span></div>
        </div>
    </div>
    <button class="submit-btn" onclick="submitOrder()">âœ… é€å‡ºç™»è¨˜è¨‚å–®</button>
</div>

<script>
    // 1. åˆå§‹åŒ– Firebase
    var config = { apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4", databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com", projectId: "zoo-62638" };
    firebase.initializeApp(config);
    var db = firebase.database();
    var cart = {}, cloudData = {};

    // 2. ç›£è½æš±ç¨± (è¼¸å…¥ 1239 é–‹å•Ÿç®¡ç†æ¨¡å¼)
    document.getElementById('user-nick').addEventListener('input', function(e){
        document.getElementById('admin-trigger').style.display = (e.target.value === '1239') ? 'block' : 'none';
    });

    // 3. è®€å–å•†å“
    db.ref('products').on('value', function(sn){
        cloudData = sn.val() || {};
        renderMain();
    });

    function renderMain(){
        var grid = document.getElementById('main-grid'); grid.innerHTML = '';
        Object.keys(cloudData).forEach(c => {
            if(!c.startsWith('-')) grid.innerHTML += `<div class="cat-card" onclick="openCat('${c}')">ğŸ“‚ ${c}</div>`;
        });
    }

    // 4. æ‰“é–‹åˆ†é¡ (å·¦è³‡è¨Šã€å³åŠ æ¸›)
    function openCat(cat){
        document.getElementById('cat-title').innerText = cat;
        var list = document.getElementById('p-list'); list.innerHTML = '';
        var items = cloudData[cat];
        Object.keys(items).forEach(id => {
            var p = items[id];
            var specs = (p.s || "å–®ä¸€è¦æ ¼").split(',');
            var specHtml = specs.map(s => {
                var k = `${cat}|${id}|${s.trim()}`;
                return `
                <div class="spec-item">
                    <div class="spec-info"><b>${s.trim()}</b><br><span style="color:var(--red)">$${p.p}</span></div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty('${k}',-1)">-</button>
                        <span id="num-${k}" style="min-width:20px; text-align:center">${cart[k]||0}</span>
                        <button class="qty-btn" onclick="updateQty('${k}',1)">+</button>
                    </div>
                </div>`;
            }).join('');
            list.innerHTML += `
                <div class="p-group">
                    <div class="p-header">
                        <img class="p-img" src="${p.img || 'https://via.placeholder.com/50'}">
                        <span>${p.n}</span>
                    </div>
                    ${specHtml}
                </div>`;
        });
        document.getElementById('item-modal').style.display = 'flex';
    }

    // 5. æ ¸å¿ƒï¼šæ•¸é‡æ›´æ–°èˆ‡ UI åŒæ­¥
    function updateQty(k, d){
        cart[k] = (cart[k] || 0) + d;
        if(cart[k] <= 0) delete cart[k];
        
        // æ›´æ–°æ‰€æœ‰åœ°æ–¹çš„æ•¸å­—é¡¯ç¤º
        var els = document.querySelectorAll(`[id="num-${k}"]`);
        els.forEach(el => el.innerText = cart[k] || 0);
        
        updateCartUI();
    }

    function updateCartUI(){
        var bar = document.getElementById('order-bar'), list = document.getElementById('cart-items-list'), total = 0, count = 0;
        var keys = Object.keys(cart);
        if(!keys.length){ 
            bar.style.display='none'; 
            document.getElementById('cart-drawer').style.display='none';
            return; 
        }
        bar.style.display='block'; list.innerHTML = '';
        
        keys.forEach(k => {
            var p = k.split('|');
            var info = cloudData[p[0]][p[1]];
            total += info.p * cart[k];
            count += cart[k];
            list.innerHTML += `
            <div class="drawer-item">
                <div style="flex:1; font-size:0.9em"><b>${info.n}</b><br><small>${p[2]}</small></div>
                <div class="qty-controls">
                    <button class="qty-btn" style="width:25px;height:25px;font-size:14px" onclick="updateQty('${k}',-1)">-</button>
                    <span>${cart[k]}</span>
                    <button class="qty-btn" style="width:25px;height:25px;font-size:14px" onclick="updateQty('${k}',1)">+</button>
                </div>
            </div>`;
        });
        document.getElementById('total-val').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    function toggleDrawer(){
        var d = document.getElementById('cart-drawer');
        d.style.display = (d.style.display==='none') ? 'block' : 'none';
    }

    // 6. ä¸‹å–®
    function submitOrder(){
        var nick = document.getElementById('user-nick').value;
        if(!nick || nick==='1239') return alert("è«‹è¼¸å…¥æš±ç¨±ä»¥ä¾¿ç™»è¨˜");
        if(confirm("ç¢ºå®šé€å‡ºé€™ " + document.getElementById('cart-count').innerText + " ä»¶å•†å“çš„ç™»è¨˜å—ï¼Ÿ")){
            db.ref('orders').push({
                nick: nick,
                time: new Date().toLocaleString(),
                items: cart,
                total: document.getElementById('total-val').innerText
            }).then(() => {
                alert("âœ… ç™»è¨˜æˆåŠŸï¼è«‹è¨˜å¾—æˆªåœ–æ˜ç´°çµ¦ 33 å”·ï¼");
                cart = {}; updateCartUI(); closeModal();
            });
        }
    }

    // 7. ç®¡ç†å“¡åŠŸèƒ½ï¼šExcel åŒ¯å‡º
    function exportExcel(){
        db.ref('orders').once('value', sn => {
            var data = [];
            sn.forEach(d => {
                var v = d.val();
                Object.keys(v.items).forEach(k => {
                    var p = k.split('|');
                    data.push({ "æš±ç¨±": v.nick, "æ™‚é–“": v.time, "åˆ†é¡": p[0], "å•†å“": cloudData[p[0]][p[1]].n, "è¦æ ¼": p[2], "æ•¸é‡": v.items[k], "ç¸½é¡": v.total });
                });
            });
            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, "33æ—¥æœ¬å‹•ç‰©åœ’è¨‚å–®.xlsx");
        });
    }

    // å…¶ä»–åŸºç¤å‡½æ•¸
    function toggleAdmin(){ 
        var x = document.getElementById('admin-area');
        x.style.display = (x.style.display==='none') ? 'block' : 'none';
        if(x.style.display==='block') loadAllOrders();
    }
    function closeModal(){ document.getElementById('item-modal').style.display='none'; }
    function saveProduct(){
        var c=document.getElementById('ad-cat').value, n=document.getElementById('ad-name').value, p=document.getElementById('ad-price').value, s=document.getElementById('ad-spec').value, img=document.getElementById('ad-img').value;
        if(!c||!n||!p) return alert("è³‡æ–™ä¸å…¨");
        db.ref('products/'+c).push({n:n, p:parseInt(p), s:s||"å–®ä¸€è¦æ ¼", img:img});
        alert("ä¸Šæ¶æˆåŠŸ");
    }
    function loadAllOrders(){
        db.ref('orders').once('value', sn => {
            var html = '<table><tr><th>æš±ç¨±</th><th>å…§å®¹</th></tr>';
            sn.forEach(d => {
                var v = d.val(); var detail = "";
                if(v.items) Object.keys(v.items).forEach(k => { var p = k.split('|'); detail += `${p[2]} x${v.items[k]}<br>`; });
                html += `<tr><td>${v.nick}</td><td>${detail}</td></tr>`;
            });
            document.getElementById('order-table').innerHTML = html + '</table>';
        });
    }
    function fetchHistory(){
        var nick = document.getElementById('user-nick').value;
        if(!nick) return alert("è«‹è¼¸å…¥æš±ç¨±å†æŸ¥è©¢");
        db.ref('orders').orderByChild('nick').equalTo(nick).once('value', sn => {
            if(!sn.exists()) return alert("æŸ¥ç„¡ç™»è¨˜ç´€éŒ„");
            var msg = "æ‚¨å¥½ " + nick + "ï¼ŒæŸ¥åˆ°ä»¥ä¸‹ç´€éŒ„ï¼š\n";
            sn.forEach(d => msg += `\nğŸ“… ${d.val().time}\né‡‘é¡ï¼š$${d.val().total}\n`);
            alert(msg);
        });
    }
</script>
</body>
</html>
