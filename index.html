<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33 ä»£è³¼ç™»è¨˜ - æœ€çµ‚ä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main-blue: #2c3e50; --bg: #fdfdfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        /* 1. å…¥å£ç•«é¢ */
        #entry-page { 
            position: fixed; inset: 0; background: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; 
        }
        .entry-box { width: 85%; max-width: 320px; text-align: center; }
        .btn-main { 
            width: 100%; padding: 16px; margin: 12px 0; border-radius: 12px; border: 1px solid #eee;
            background: white; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .btn-primary { background: var(--main-blue); color: white; border: none; font-weight: bold; }

        /* 2. ä¸»å…§å®¹å€ */
        header { padding: 25px 20px; text-align: center; font-size: 1.3em; font-weight: bold; border-bottom: 1px solid #f0f0f0; background: white; }
        .container { padding: 15px; max-width: 600px; margin: auto; padding-bottom: 250px; }
        
        .item-row { 
            background: white; padding: 18px; border-radius: 15px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #f0f0f0; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .item-name { font-weight: bold; font-size: 1.1em; }
        .item-price { color: #003399; font-weight: bold; }
        .item-stock { font-size: 0.85em; color: #999; }

        /* 3. åº•éƒ¨ç™»è¨˜æŠ½å±œ */
        #bottom-cart { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            padding: 20px; border-top: 1px solid #eee; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            display: none; flex-direction: column; gap: 15px; z-index: 2000;
        }
        .nickname-input { padding: 15px; border: 1.5px solid #eee; border-radius: 10px; font-size: 1em; width: 100%; box-sizing: border-box; }
        .qty-row { display: flex; justify-content: space-between; align-items: center; background: #f8f8f8; padding: 10px 15px; border-radius: 10px; }

        /* 4. é¢æ¿èˆ‡å½ˆçª— */
        .panel { position: fixed; inset: 0; background: white; z-index: 5000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .tag { padding: 2px 8px; border-radius: 5px; font-size: 0.75em; font-weight: bold; margin-left: 6px; color: white; }
        
        /* è€é—†é–€ï¼šæ¥µå°é» */
        .admin-gate { position: absolute; bottom: 10px; right: 10px; color: #f0f0f0; font-size: 0.8em; cursor: pointer; padding: 10px; }
    </style>
</head>
<body>

<div id="entry-page">
    <div class="entry-box">
        <h2 style="letter-spacing: 2px;">33 ä»£è³¼ç™»è¨˜</h2>
        <button class="btn-main btn-primary" onclick="enterOrder()">ğŸ›ï¸ æˆ‘è¦ç™»è¨˜</button>
        <button class="btn-main" onclick="openSearch()">ğŸ” æŸ¥è©¢ç´€éŒ„</button>
    </div>
    <div class="admin-gate" onclick="enterAdmin()">.</div>
</div>

<header>ç™»è¨˜å“é …æ¸…å–®</header>

<div class="container" id="item-list">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</div>

<div id="bottom-cart">
    <div style="font-weight: bold; border-left: 4px solid var(--main-blue); padding-left: 10px;" id="selected-name">å°šæœªé¸æ“‡å•†å“</div>
    <div class="qty-row">
        <span>ç™»è¨˜æ•¸é‡</span>
        <input type="number" id="qty-input" value="1" min="1" style="width: 80px; text-align: center; border:none; background:none; font-size:1.2em; font-weight:bold;" oninput="updateTotal()">
    </div>
    <input type="text" id="nickname" class="nickname-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨± (å¿…å¡«)">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
        <span id="total-price" style="font-size: 1.5em; font-weight: bold; color: #d9534f;">$ 0</span>
        <button onclick="submitOrder()" style="width: 60%; padding: 15px; background: var(--main-blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">ç¢ºèªé€å‡º</button>
    </div>
    <button onclick="closeCart()" style="background: none; border: none; color: #bbb; margin-top: 5px; cursor: pointer;">å–æ¶ˆ</button>
</div>

<div id="user-search-panel" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h3>ğŸ” æŸ¥è©¢æˆ‘çš„ç™»è¨˜</h3>
        <button onclick="closeSearch()" style="border:none; background:none; font-size:1.5em;">âœ•</button>
    </div>
    <input type="text" id="search-name" class="nickname-input" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±">
    <button class="btn-main btn-primary" onclick="searchOrders()">é–‹å§‹æœå°‹</button>
    <div id="search-result" style="margin-top:20px;"></div>
    <button onclick="location.reload()" style="margin-top: 30px; border:none; background:none; color:#ccc; width:100%;">å›åˆ°é¦–é </button>
</div>

<div id="admin-panel" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>âš™ï¸ è€é—†å¾Œå°</h3>
        <button onclick="togglePanel('admin-panel')">âœ•</button>
    </div>
    <div style="background:#fff3cd; padding:15px; border-radius:10px; margin-bottom:20px; font-size:0.9em; border:1px solid #ffeeba;">
        <strong>å¿«é€Ÿæ“ä½œï¼š</strong><br>
        <button onclick="initSJGoods()" style="margin-top:10px; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; width:100%; cursor:pointer;">ğŸ”„ é»æˆ‘æ–°å¢ 9 ä½æˆå“¡å¨ƒå¨ƒå•†å“</button>
    </div>
    <div id="history-list"></div>
</div>

<script>
// --- Firebase æ ¸å¿ƒé…ç½® ---
const firebaseConfig = {
    apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
    authDomain: "zoo-62638.firebaseapp.com",
    databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
    projectId: "zoo-62638",
    storageBucket: "zoo-62638.firebasestorage.app",
    messagingSenderId: "33012710753",
    appId: "1:33012710753:web:318636add1f5ac2f7b5920"
};

// ç¢ºä¿ Firebase åªåˆå§‹åŒ–ä¸€æ¬¡
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

let products = [];
let allOrders = {};
let selectedItem = null;

// --- æŒ‰éˆ•é»æ“Šå‡½å¼ (ä¿®æ­£ç„¡åæ‡‰å•é¡Œ) ---
function enterOrder() {
    console.log("é€²å…¥ç™»è¨˜é é¢");
    document.getElementById('entry-page').style.display = 'none';
}

function openSearch() {
    document.getElementById('user-search-panel').style.display = 'flex';
}

function closeSearch() {
    document.getElementById('user-search-panel').style.display = 'none';
}

function togglePanel(id) {
    const p = document.getElementById(id);
    p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
}

function enterAdmin() {
    const pw = prompt("ğŸ” ç®¡ç†ç™»å…¥ï¼š");
    if (pw === "3388") {
        document.getElementById('admin-panel').style.display = 'flex';
    } else if (pw !== null) {
        alert("å¯†ç¢¼éŒ¯èª¤");
    }
}

// --- å•†å“åˆå§‹åŒ–åŠŸèƒ½ (9ä½æˆå“¡) ---
function initSJGoods() {
    const list = [
        { id: 101, sort: 1, name: "ç‰¹é´¨", price: 950, stock: 3 },
        { id: 102, sort: 2, name: "æ¾ˆå­”é›€", price: 950, stock: 3 },
        { id: 103, sort: 3, name: "é›²è²“", price: 950, stock: 3 },
        { id: 104, sort: 4, name: "ç«¥ç†Šè²“", price: 950, stock: 3 },
        { id: 105, sort: 5, name: "èµ«å…”", price: 950, stock: 3 },
        { id: 106, sort: 6, name: "æµ·ç‹—", price: 950, stock: 3 },
        { id: 107, sort: 7, name: "æºé¦¬", price: 950, stock: 3 },
        { id: 108, sort: 8, name: "æ—­é•·é ¸é¹¿", price: 950, stock: 3 },
        { id: 109, sort: 9, name: "åœ­ä¼éµ", price: 950, stock: 3 }
    ];
    if(confirm("å°‡æ–°å¢ 9 ä½æˆå“¡å•†å“ï¼Œæ˜¯å¦ç¢ºå®šï¼Ÿ")) {
        db.ref("products").set(list).then(() => alert("å•†å“å·²æˆåŠŸä¸Šæ¶ï¼"));
    }
}

// --- å³æ™‚ç›£è½è³‡æ–™åº« ---
db.ref("products").on("value", (s) => {
    products = s.val() || [];
    products.sort((a,b) => (a.sort || 999) - (b.sort || 999));
    const container = document.getElementById('item-list');
    container.innerHTML = products.map(p => `
        <div class="item-row" onclick="openCart(${p.id})">
            <div>
                <div class="item-name">${p.name}</div>
                <div class="item-price">$ ${p.price}</div>
            </div>
            <div class="item-stock">é™é¡ ${p.stock}</div>
        </div>
    `).join('') || "ç›®å‰æ²’æœ‰å•†å“ï¼Œè«‹ç”±è€é—†å¾Œå°é»æ“Šã€Œå¿«é€Ÿæ–°å¢ã€ã€‚";
});

db.ref("history").on("value", (s) => {
    allOrders = s.val() || {};
    renderAdminHistory();
});

// --- ç™»è¨˜è¦–çª—æ“ä½œ ---
function openCart(id) {
    selectedItem = products.find(p => p.id === id);
    if(!selectedItem) return;
    document.getElementById('selected-name').innerText = `ç™»è¨˜é …ç›®ï¼š${selectedItem.name}`;
    document.getElementById('qty-input').value = 1;
    document.getElementById('bottom-cart').style.display = 'flex';
    updateTotal();
}

function closeCart() {
    document.getElementById('bottom-cart').style.display = 'none';
}

function updateTotal() {
    const qty = parseInt(document.getElementById('qty-input').value) || 0;
    document.getElementById('total-price').innerText = `$ ${qty * (selectedItem ? selectedItem.price : 0)}`;
}

// --- é€å‡ºç™»è¨˜ ---
async function submitOrder() {
    const nick = document.getElementById('nickname').value.trim();
    const qty = parseInt(document.getElementById('qty-input').value);
    if(!nick || qty <= 0 || !selectedItem) return alert("è«‹å¡«å¯«æ­£ç¢ºçš„æš±ç¨±èˆ‡æ•¸é‡");
    
    const newOrder = {
        time: new Date().toLocaleString(),
        timestamp: Date.now(),
        items: [{ name: selectedItem.name, qty: qty, price: selectedItem.price }],
        total: qty * selectedItem.price,
        note: nick
    };

    try {
        await db.ref("history").push(newOrder);
        alert("âœ… ç™»è¨˜å®Œæˆï¼");
        closeCart();
        document.getElementById('nickname').value = "";
    } catch (e) {
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
    }
}

// --- é †ä½è¨ˆç®—é‚è¼¯ ---
function getTag(key, name) {
    const relevantOrders = Object.keys(allOrders).map(k => ({k, ...allOrders[k]}))
        .filter(o => o.items.some(i => i.name === name))
        .sort((a,b) => a.timestamp - b.timestamp);
    
    let currentCount = 0;
    const limit = (products.find(p => p.name === name) || {}).stock || 0;
    
    for (let o of relevantOrders) {
        const item = o.items.find(i => i.name === name);
        const startNum = currentCount + 1;
        currentCount += item.qty;
        
        if(o.k === key) {
            if (startNum <= limit) {
                return `<span class="tag" style="background:#4caf50;">é †ä½ ${startNum}</span>`;
            } else {
                return `<span class="tag" style="background:#ff9800;">å€™è£œ ${startNum - limit}</span>`;
            }
        }
    }
}

// --- æŸ¥è©¢åŠŸèƒ½ ---
function searchOrders() {
    const name = document.getElementById('search-name').value.trim();
    if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
    const myOrders = Object.keys(allOrders).filter(k => allOrders[k].note === name).sort((a,b) => allOrders[b].timestamp - allOrders[a].timestamp);
    const resultDiv = document.getElementById('search-result');
    
    if(myOrders.length === 0) {
        resultDiv.innerHTML = "æ‰¾ä¸åˆ°ç´€éŒ„ï¼Œè«‹æª¢æŸ¥æš±ç¨±æ˜¯å¦è¼¸å…¥æ­£ç¢ºã€‚";
        return;
    }

    resultDiv.innerHTML = myOrders.map(k => `
        <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #eee;">
            <div style="font-size:0.8em; color:#999; margin-bottom:5px;">${allOrders[k].time}</div>
            ${allOrders[k].items.map(i => `<div style="font-weight:bold;">${i.name} x ${i.qty} ${getTag(k, i.name)}</div>`).join('')}
        </div>
    `).join('');
}

// --- è€é—†å¾Œå°æ­·å²æ¸…å–® ---
function renderAdminHistory() {
    const list = document.getElementById('history-list');
    const sortedKeys = Object.keys(allOrders).sort((a,b) => allOrders[a].timestamp - allOrders[b].timestamp);
    list.innerHTML = sortedKeys.map(k => `
        <div style="border-bottom:1px solid #eee; padding:10px; font-size:0.9em;">
            <strong>${allOrders[k].note}</strong> <small style="color:#999;">(${allOrders[k].time})</small>
            <button onclick="delOrder('${k}')" style="float:right; color:red; border:none; background:none; cursor:pointer;">âœ•</button>
            <br>${allOrders[k].items.map(i => `${i.name} x ${i.qty} ${getTag(k, i.name)}`).join('')}
        </div>
    `).join('');
}

function delOrder(k) {
    if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç™»è¨˜ï¼Ÿ")) db.ref("history").child(k).remove();
}
</script>
</body>
</html>
