<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33æ—¥æœ¬å‹•ç‰©åœ’ - åœ’é•·ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --matcha: #606C38; --rice: #FEF9EF; --caramel: #BC6C25; --wood: #283618; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; }
        body { margin: 0; background: var(--rice); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å¤§å»³ */
        .hall { position: fixed; inset: 0; background: var(--rice); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .grid-hall { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; margin-top: 20px; }
        .card-hall { background: #FFF; padding: 25px 10px; border-radius: 15px; border: 1px solid #EAE2D1; text-align: center; box-shadow: 0 4px 0 #EAE2D1; font-weight: bold; color: var(--wood); cursor: pointer; }

        /* ä¸»å®¹å™¨ */
        .app-container { display: none; flex: 1; height: 100vh; overflow: hidden; }
        .list-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .prod-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .prod-card { background: #FFF; border: 1px solid #EEE; border-radius: 12px; padding: 10px; text-align: center; }
        .prod-name { font-weight: bold; font-size: 14px; color: #333; }
        .prod-limit { font-size: 11px; color: #BC6C25; height: 16px; font-weight: bold; }
        .prod-price { color: var(--caramel); font-weight: bold; font-size: 16px; margin: 5px 0; }
        
        /* æ•¸é‡æ§åˆ¶ */
        .qty-ctrl { display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 8px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #DDD; background: #FFF; cursor: pointer; }
        .qty-num { font-weight: bold; min-width: 20px; }
        .btn-add { background: var(--matcha); color: #FFF; border: none; padding: 8px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }

        /* è³¼ç‰©è»Šå€åŸŸ - æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        .cart-area { width: 320px; background: #FFF; border-left: 2px solid #F5F5F5; display: flex; flex-direction: column; }
        .cart-header { padding: 15px; border-bottom: 1px solid #EEE; font-weight: bold; }
        #cart-items { flex: 1; overflow-y: auto; padding: 0 15px; }
        .cart-footer { padding: 15px; background: #FFF; border-top: 1px solid #EEE; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }

        /* å½ˆçª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 15px; }
        .modal-box { background: var(--rice); padding: 20px; border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .input-std { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #DDD; border-radius: 10px; font-size: 16px; }

        /* æ‰‹æ©Ÿç‰ˆé©æ‡‰ */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .prod-grid { grid-template-columns: 1fr 1fr; }
            .cart-area { width: 100%; height: 45%; border-left: none; position: relative; }
            .list-area { height: 55%; }
            .cart-footer { position: sticky; bottom: 0; z-index: 10; padding-bottom: 25px; }
        }

        /* å¾Œå° */
        #admin-panel { position: fixed; inset: 0; background: #F8F9FA; z-index: 4000; display: none; flex-direction: column; }
        .admin-header { background: var(--wood); color: #FFF; padding: 15px; display: flex; justify-content: space-between; }
        .admin-card { background: #FFF; margin: 10px; padding: 15px; border-radius: 10px; border: 1px solid #EEE; }
    </style>
</head>
<body>

<div id="hall-screen" class="hall">
    <h1 style="color:var(--matcha);">33 æ—¥æœ¬å‹•ç‰©åœ’</h1>
    <div id="hall-grid" class="grid-hall"></div>
    <button onclick="document.getElementById('search-modal').style.display='flex'" style="background:var(--caramel); color:#FFF; border:none; padding:15px 30px; border-radius:30px; margin-top:20px; font-weight:bold;">ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚å–®</button>
    <div onclick="adminLogin()" style="margin-top:40px; color:#DDD; font-size:10px;">ADMIN</div>
</div>

<div class="app-container" id="main-app">
    <div class="list-area"><div id="prod-list" class="prod-grid"></div></div>
    
    <div class="cart-area">
        <div class="cart-header">ğŸ›’ è³¼ç‰©æ¸…å–®</div>
        <div id="cart-items"></div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:18px;">
                <span>ç¸½è¨ˆ:</span><b style="color:var(--caramel);">$<span id="cart-total">0</span></b>
            </div>
            <input id="nick" class="input-std" placeholder="æ‚¨çš„ LINE æš±ç¨±">
            <button class="btn-add" id="submit-btn" style="background:var(--caramel); padding:15px; font-size:16px;" onclick="submitOrder()">ç¢ºèªä¸‹å–®</button>
            <button onclick="location.reload()" style="background:none; border:none; color:#999; width:100%; margin-top:10px;">â† è¿”å›ç›®éŒ„</button>
        </div>
    </div>
</div>

<div id="search-modal" class="modal"><div class="modal-box" id="search-box"><h2>è¨‚å–®æŸ¥è©¢</h2><input id="search-nick" class="input-std" placeholder="LINEæš±ç¨±"><div id="search-res"></div><button class="btn-add" onclick="performSearch()">æœå°‹</button><button onclick="this.parentElement.parentElement.style.display='none'">é—œé–‰</button></div></div>
<div id="admin-panel">
    <div class="admin-header"><b>åœ’é•· 33 å¾Œå°</b><button onclick="document.getElementById('admin-panel').style.display='none'">é—œé–‰</button></div>
    <div style="display:flex; gap:5px; padding:10px;"><button class="btn-add" onclick="renderAdminOrders()">è¨‚å–®ç®¡ç†</button><button class="btn-add" onclick="renderAdminProds()">å•†å“ç¶­è­·</button></div>
    <div id="admin-main" style="overflow-y:auto; flex:1; padding:10px;"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
        authDomain: "zoo-62638.firebaseapp.com",
        databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
        projectId: "zoo-62638",
        storageBucket: "zoo-62638.firebasestorage.app",
        messagingSenderId: "33012710753",
        appId: "1:33012710753:web:318636add1f5ac2f7b5920"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [], orders = {}, cart = [], curS = {}, currentEvent = "", quantities = {};

    db.ref('products').on('value', snap => { products = snap.val() || []; renderHall(); if(currentEvent) openShop(currentEvent); });
    db.ref('orders').on('value', snap => { orders = snap.val() || {}; });

    function renderHall() {
        const evts = [...new Set(products.map(p => p.e))].filter(e => e);
        document.getElementById('hall-grid').innerHTML = evts.map(e => `<div class="card-hall" onclick="openShop('${e}')">${e}</div>`).join('');
    }

    function openShop(e) {
        currentEvent = e;
        document.getElementById('hall-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        const list = products.filter(p => p.e === e);
        document.getElementById('prod-list').innerHTML = list.map(p => {
            const pid = products.findIndex(pr => pr.n === p.n && pr.e === p.e);
            if(!quantities[pid]) quantities[pid] = 1;
            const limitT = (p.limit && p.limit < 999) ? `é™è³¼ ${p.limit} ä»½` : ''; 
            return `<div class="prod-card">
                <div class="prod-name">${p.n}</div><div class="prod-limit">${limitT}</div><div class="prod-price">$${p.p}</div>
                <div style="min-height:30px;">${p.s ? p.s.split(',').map(v=>`<button onclick="setS(${pid},'${v}')" id="s-${pid}-${v}" style="border:1px solid #DDD; margin:2px; font-size:10px; background:#FFF; border-radius:4px;">${v}</button>`).join('') : ''}</div>
                <div class="qty-ctrl"><button class="qty-btn" onclick="updateQty(${pid},-1)">-</button><span id="q-${pid}">${quantities[pid]}</span><button class="qty-btn" onclick="updateQty(${pid},1)">+</button></div>
                <button class="btn-add" onclick="addToCart(${pid})">åŠ å…¥</button>
            </div>`;
        }).join('');
    }

    function updateQty(pid, d) { quantities[pid] = Math.max(1, (quantities[pid]||1) + d); document.getElementById(`q-${pid}`).innerText = quantities[pid]; }
    function setS(pid, v) { curS[pid] = v; document.querySelectorAll(`[id^="s-${pid}-"]`).forEach(b => b.style.borderColor = '#DDD'); document.getElementById(`s-${pid}-${v}`).style.borderColor = 'var(--matcha)'; }
    
    function addToCart(pid) {
        const p = products[pid]; if (p.s && !curS[pid]) return alert("è«‹é¸è¦æ ¼ï¼");
        const qty = quantities[pid] || 1;
        for(let i=0; i<qty; i++) cart.push({...p, sel: curS[pid] || "ä¸€èˆ¬", pid: pid});
        renderCart();
    }

    function renderCart() {
        let t = 0;
        document.getElementById('cart-items').innerHTML = cart.map((it, i) => { t += it.p; return `<div style="padding:8px 0; border-bottom:1px solid #EEE; display:flex; justify-content:space-between;"><span>${it.n}(${it.sel})</span><span onclick="cart.splice(${i},1);renderCart()" style="color:red;">âœ•</span></div>`; }).join('');
        document.getElementById('cart-total').innerText = t;
    }

    function submitOrder() {
        const n = document.getElementById('nick').value.trim();
        const btn = document.getElementById('submit-btn');
        if (!n || cart.length === 0) return alert("è«‹å¡«å¯«æš±ç¨±åŠå•†å“");
        btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
        db.ref('orders').push({ nick: n, items: cart, total: cart.reduce((a,b)=>a+b.p,0), time: Date.now(), forceWin: false })
          .then(() => { alert("è¨‚å–®å·²æäº¤ï¼"); location.reload(); })
          .catch(() => { alert("å¤±æ•—"); btn.disabled = false; });
    }

    function adminLogin() { if(prompt("å¯†ç¢¼")==="1239") { document.getElementById('admin-panel').style.display='flex'; renderAdminOrders(); } }
    function renderAdminOrders() {
        const sorted = Object.entries(orders).sort((a,b) => a[1].time - b[1].time);
        document.getElementById('admin-main').innerHTML = `<button class="btn-add" onclick="mergeOrders()">åˆä½µè¨‚å–®</button>` + sorted.map(([k, o]) => `<div class="admin-card"><input type="checkbox" class="merge-check" value="${k}" data-nick="${o.nick}"> <b>${o.nick}</b> ($${o.total})<br>${o.items.map(it=>it.n).join(', ')}<br><button onclick="db.ref('orders/${k}').remove()">åˆªé™¤</button></div>`).join('');
    }
    // ... å•†å“ç¶­è­·ç­‰å…¶ä»–å¾Œå°é‚è¼¯æ¯”ç…§è¾¦ç† ...
    function renderAdminProds() {
        document.getElementById('admin-main').innerHTML = `<button class="btn-add" onclick="products.push({e:'æ–°åˆ†é¡',n:'æ–°å•†å“',p:0});db.ref('products').set(products)">ï¼‹ æ–°å¢</button>` + products.map((p, i) => `<div class="admin-card">${p.n} <button onclick="let n=prompt('å',p.n);if(n)products[i].n=n;db.ref('products').set(products)">æ”¹å</button></div>`).join('');
    }
</script>
</body>
</html>
