<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33 ä»£è³¼ç™»è¨˜</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #2c3e50; --accent: #003399; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #333; overflow-x: hidden; }
        
        /* å…¨åŸŸé ‚éƒ¨å°èˆª */
        header { 
            background: var(--main); color: white; padding: 15px; 
            text-align: center; font-weight: bold; font-size: 1.2em;
            position: sticky; top: 0; z-index: 8000; cursor: pointer;
        }

        /* é¦–é å…¥å£å±¤ */
        #home-layer { 
            position: fixed; inset: 0; background: white; z-index: 7000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-box { width: 80%; max-width: 300px; }
        .btn-big { 
            width: 100%; padding: 20px; margin: 10px 0; border-radius: 15px; border: 1px solid #ddd;
            background: white; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-blue { background: var(--main); color: white; border: none; }

        /* å•†å“æ¸…å–®å€ */
        .container { padding: 15px; max-width: 600px; margin: auto; padding-bottom: 250px; }
        .item-card { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee; cursor: pointer;
        }
        .price { color: var(--accent); font-weight: bold; }

        /* åº•éƒ¨å½ˆå‡ºç™»è¨˜å€ */
        #bottom-panel { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            padding: 20px; border-top: 1px solid #ddd; box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            display: none; flex-direction: column; gap: 15px; z-index: 6000;
        }
        .input-box { padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1em; width: 100%; box-sizing: border-box; }

        /* å…¨è¢å¹•è¦†è“‹é¢æ¿ (æŸ¥è©¢/å¾Œå°) */
        .full-panel { 
            position: fixed; inset: 0; background: white; z-index: 9000; 
            display: none; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag { padding: 3px 8px; border-radius: 5px; font-size: 0.75em; color: white; margin-left: 5px; font-weight: bold; }
        .tag-ok { background: #4caf50; }
        .tag-wait { background: #ff9800; }

        /* éš±è—è€é—†å…¥å£ */
        .admin-trigger { position: absolute; bottom: 10px; right: 10px; color: #f0f0f0; font-size: 0.6em; cursor: pointer; padding: 10px; }
    </style>
</head>
<body>

<header onclick="goHome()">ğŸ’™ 33 ä»£è³¼ç™»è¨˜</header>

<div id="home-layer">
    <div class="menu-box">
        <button class="btn-big btn-blue" onclick="showList()">ğŸ›ï¸ æˆ‘è¦ç™»è¨˜å•†å“</button>
        <button class="btn-big" onclick="openPanel('search-panel')">ğŸ” æŸ¥è©¢ç´€éŒ„ / é †ä½</button>
    </div>
    <div class="admin-trigger" onclick="adminLogin()">.</div>
</div>

<div class="container" id="main-item-list">è®€å–ä¸­...</div>

<div id="bottom-panel">
    <div style="font-weight: bold; color: var(--accent);" id="target-name">å•†å“åç¨±</div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>æ•¸é‡ï¼š</span>
        <input type="number" id="target-qty" value="1" min="1" style="width: 70px; padding: 8px; text-align: center; border-radius: 5px; border: 1px solid #ddd;">
    </div>
    <input type="text" id="user-nick" class="input-box" placeholder="è«‹è¼¸å…¥ç™»è¨˜æš±ç¨± (å¿…å¡«)">
    <div style="display: flex; gap: 10px;">
        <button onclick="submitData()" style="flex: 2; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold;">ç¢ºèªé€å‡º</button>
        <button onclick="closeBottom()" style="flex: 1; padding: 15px; background: #eee; border: none; border-radius: 10px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="search-panel" class="full-panel">
    <div class="panel-header">
        <h3>ğŸ” æŸ¥è©¢ç™»è¨˜çµæœ</h3>
        <button onclick="closePanel('search-panel')" style="border:none; background:none; font-size:1.5em;">âœ•</button>
    </div>
    <input type="text" id="q-nick" class="input-box" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±">
    <button class="btn-big btn-blue" onclick="doSearch()">ç«‹å³æœå°‹</button>
    <div id="q-result" style="margin-top:20px;"></div>
    <button onclick="goHome()" style="margin-top:30px; color:#999; border:none; background:none; width:100%;">è¿”å›é¦–é é¸å–®</button>
</div>

<div id="admin-panel" class="full-panel">
    <div class="panel-header">
        <h3>âš™ï¸ è€é—†ç®¡ç†å¾Œå°</h3>
        <button onclick="closePanel('admin-panel')" style="border:none; background:none; font-size:1.5em;">âœ•</button>
    </div>
    <div style="background:#e7f3ff; padding:15px; border-radius:10px; margin-bottom:20px;">
        <strong>å¿«é€Ÿåˆå§‹åŒ–ï¼š</strong><br>
        <button onclick="seedSJ()" style="width:100%; padding:12px; margin-top:10px; background:#007bff; color:white; border:none; border-radius:8px;">ğŸ”„ ä¸€éµä¸Šæ¶ 9 æ¬¾æˆå“¡å¨ƒå¨ƒ</button>
    </div>
    <div id="adm-history"></div>
</div>

<script>
// --- Firebase è¨­å®š ---
const firebaseConfig = {
    apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
    authDomain: "zoo-62638.firebaseapp.com",
    databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
    projectId: "zoo-62638",
    storageBucket: "zoo-62638.firebasestorage.app",
    messagingSenderId: "33012710753",
    appId: "1:33012710753:web:318636add1f5ac2f7b5920"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let items = [];
let orders = {};
let activeItem = null;

// --- å°èˆªèˆ‡è·³è½‰åŠŸèƒ½ (è§£æ±ºä¸æ–¹ä¾¿çš„å•é¡Œ) ---
function goHome() {
    document.getElementById('home-layer').style.display = 'flex';
    document.querySelectorAll('.full-panel').forEach(p => p.style.display = 'none');
    closeBottom();
}

function showList() {
    document.getElementById('home-layer').style.display = 'none';
}

function openPanel(id) {
    document.getElementById(id).style.display = 'flex';
}

function closePanel(id) {
    document.getElementById(id).style.display = 'none';
}

function adminLogin() {
    const p = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
    if(p === "3388") openPanel('admin-panel');
}

// --- å•†å“åˆå§‹åŒ– (SJ 9ä½æˆå“¡) ---
function seedSJ() {
    const sj = [
        { id: 101, sort: 1, name: "ç‰¹é´¨", price: 950, stock: 3 },
        { id: 102, sort: 2, name: "æ¾ˆå­”é›€", price: 950, stock: 3 },
        { id: 103, sort: 3, name: "é›²è²“", price: 950, stock: 3 },
        { id: 104, sort: 4, name: "ç«¥ç†Šè²“", price: 950, stock: 3 },
        { id: 105, sort: 5, name: "èµ«å…”", price: 950, stock: 3 },
        { id: 106, sort: 6, name: "æµ·ç‹—", price: 950, stock: 3 },
        { id: 107, sort: 7, name: "æºé¦¬", price: 950, stock: 3 },
        { id: 108, sort: 8, name: "æ—­é•·é ¸é¹¿", price: 950, stock: 3 },
        { id: 109, sort: 9, name: "åœ­ä¼éµ", price: 950, stock: 3 }
    ];
    if(confirm("å°‡é‡è¨­ç‚º 9 ä½æˆå“¡å•†å“ï¼Œç¢ºå®šå—ï¼Ÿ")) {
        db.ref("products").set(sj).then(() => alert("å•†å“å·²å°±ç·’ï¼"));
    }
}

// --- è³‡æ–™ç›£è½èˆ‡æ¸²æŸ“ ---
db.ref("products").on("value", (s) => {
    items = s.val() || [];
    items.sort((a,b) => a.sort - b.sort);
    const listDiv = document.getElementById('main-item-list');
    listDiv.innerHTML = items.map(i => `
        <div class="item-card" onclick="startOrder(${i.id})">
            <div>
                <div style="font-weight:bold;">${i.name}</div>
                <div class="price">$ ${i.price}</div>
            </div>
            <div style="font-size:0.8em; color:#999;">é™é¡ ${i.stock}</div>
        </div>
    `).join('') || "ç›®å‰ç„¡å•†å“ï¼Œè«‹é€²å¾Œå°åˆå§‹åŒ–ã€‚";
});

db.ref("history").on("value", (s) => {
    orders = s.val() || {};
    renderAdminHistory();
});

// --- ç™»è¨˜é‚è¼¯ ---
function startOrder(id) {
    activeItem = items.find(i => i.id === id);
    document.getElementById('target-name').innerText = "ç™»è¨˜å•†å“ï¼š" + activeItem.name;
    document.getElementById('target-qty').value = 1;
    document.getElementById('bottom-panel').style.display = 'flex';
}

function closeBottom() {
    document.getElementById('bottom-panel').style.display = 'none';
}

async function submitData() {
    const nick = document.getElementById('user-nick').value.trim();
    const qty = parseInt(document.getElementById('target-qty').value);
    if(!nick || qty < 1) return alert("è«‹å®Œæ•´å¡«å¯«æš±ç¨±èˆ‡æ•¸é‡");

    const data = {
        time: new Date().toLocaleString(),
        timestamp: Date.now(),
        items: [{ name: activeItem.name, qty: qty }],
        note: nick
    };

    await db.ref("history").push(data);
    alert("âœ… ç™»è¨˜æˆåŠŸï¼");
    closeBottom();
    document.getElementById('user-nick').value = "";
}

// --- é †ä½è¨ˆç®—é‚è¼¯ ---
function calculateTag(orderKey, itemName) {
    const list = Object.keys(orders).map(k => ({k, ...orders[k]}))
        .filter(o => o.items.some(i => i.name === itemName))
        .sort((a,b) => a.timestamp - b.timestamp);
    
    let current = 0;
    const limit = (items.find(i => i.name === itemName) || {}).stock || 0;
    
    for (let o of list) {
        const it = o.items.find(i => i.name === itemName);
        const start = current + 1;
        current += it.qty;
        
        if(o.k === orderKey) {
            if (start <= limit) return `<span class="tag tag-ok">é †ä½ ${start}</span>`;
            else return `<span class="tag tag-wait">å€™è£œ ${start - limit}</span>`;
        }
    }
}

// --- æŸ¥è©¢åŠŸèƒ½ ---
function doSearch() {
    const name = document.getElementById('q-nick').value.trim();
    if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
    const my = Object.keys(orders).filter(k => orders[k].note === name).sort((a,b) => orders[b].timestamp - orders[a].timestamp);
    const resDiv = document.getElementById('q-result');
    
    resDiv.innerHTML = my.map(k => `
        <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #eee;">
            <div style="font-size:0.8em; color:#999; margin-bottom:5px;">${orders[k].time}</div>
            ${orders[k].items.map(i => `<div><strong>${i.name} x ${i.qty}</strong> ${calculateTag(k, i.name)}</div>`).join('')}
        </div>
    `).join('') || "æ‰¾ä¸åˆ°ç´€éŒ„ã€‚";
}

// --- ç®¡ç†æ­·å²æ¸²æŸ“ ---
function renderAdminHistory() {
    const div = document.getElementById('adm-history');
    const sorted = Object.keys(orders).sort((a,b) => orders[a].timestamp - orders[b].timestamp);
    div.innerHTML = sorted.map(k => `
        <div style="border-bottom:1px solid #eee; padding:10px; font-size:0.9em;">
            <strong>${orders[k].note}</strong> <small>(${orders[k].time})</small>
            <button onclick="delOrder('${k}')" style="float:right; color:red; border:none; background:none; cursor:pointer;">âœ•</button>
            <br>${orders[k].items.map(i => `${i.name} x ${i.qty} ${calculateTag(k, i.name)}`).join('')}
        </div>
    `).join('');
}

function delOrder(k) {
    if(confirm("åˆªé™¤ï¼Ÿ")) db.ref("history").child(k).remove();
}
</script>
</body>
</html>
