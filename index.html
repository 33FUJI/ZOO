<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33æ—¥æœ¬å‹•ç‰©åœ’ - åœ’é•·ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --matcha: #606C38; --rice: #FEF9EF; --caramel: #BC6C25; --earth: #283618; }
        body { background: #f0f0f0; margin: 0; font-family: sans-serif; display: flex; justify-content: center; min-height: 100dvh; }
        
        /* éŸ¿æ‡‰å¼å®¹å™¨ï¼šé›»è…¦æœ€å¤§ 1000pxï¼Œæ‰‹æ©Ÿè‡ªå‹• 100% */
        .app-container { 
            width: 100%; 
            max-width: 1000px; 
            background: var(--rice); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            height: 100dvh;
        }

        /* å¤§å»³ */
        .hall { position: absolute; inset: 0; background: var(--rice); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
            width: 90%; 
            max-width: 800px;
            margin-top: 20px; 
        }
        .card { background: #FFF; border: 2px solid #D1C7A1; border-radius: 12px; padding: 25px 10px; cursor: pointer; transition: 0.3s; }
        .card:active { transform: scale(0.95); }
        .card b { font-size: 16px; color: var(--earth); }

        /* å•†å“åˆ—è¡¨ä½ˆå±€ */
        .container { display: flex; flex: 1; flex-direction: column; overflow: hidden; visibility: hidden; }
        .list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* é›»è…¦æœƒè‡ªå‹•åˆ†æ¬„ */
            gap: 12px; 
            align-content: flex-start;
        }

        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ï¼šç•¶è¢å¹•å¯¬åº¦å°æ–¼ 600px æ™‚ï¼Œåˆ—è¡¨æ”¹å›å–®æ¬„ */
        @media (max-width: 600px) {
            .list { grid-template-columns: 1fr; }
            .cart-panel { flex-direction: column; align-items: stretch !important; }
            .cart-ctrl { width: 100%; }
        }

        .prod-card { background: #FFF; border-radius: 10px; padding: 15px; border: 1px solid #EEE; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prod-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; display: block; padding-right: 70px; }
        .prod-price { color: var(--caramel); font-size: 18px; font-weight: bold; position: absolute; top: 15px; right: 15px; }
        
        .spec-wrap { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .spec-btn { border: 1px solid #DDD; padding: 6px 12px; border-radius: 6px; background: #FFF; font-size: 14px; cursor: pointer; }
        .spec-btn.active { background: var(--matcha); color: #FFF; border-color: var(--matcha); }
        
        .row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .qty-box { display: flex; border: 1px solid #DDD; border-radius: 6px; height: 38px; background: #FFF; overflow: hidden; }
        .qty-box button { width: 40px; border: none; background: #f9f9f9; font-size: 20px; cursor: pointer; }
        .qty-box span { width: 45px; text-align: center; line-height: 38px; font-weight: bold; }
        .add-btn { flex: 1; background: var(--matcha); color: white; border: none; height: 38px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* è³¼ç‰©è»Šé¢æ¿ */
        .cart-panel { background: #FFF; border-top: 2px solid var(--matcha); padding: 15px; display: flex; gap: 20px; align-items: flex-end; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        #cart-items { flex: 1; max-height: 120px; overflow-y: auto; font-size: 14px; border: 1px inset #f0f0f0; padding: 5px; border-radius: 5px; }
        .cart-ctrl { min-width: 200px; }

        /* å¾Œå° */
        #admin { position: absolute; inset: 0; background: #FFF; z-index: 200; display: none; flex-direction: column; }
        .admin-nav { background: var(--earth); display: flex; overflow-x: auto; }
        .admin-nav button { flex: 1; color: #EEE; padding: 15px; border: none; background: none; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .admin-nav button.active { background: #3d5225; font-weight: bold; color: #FFF; }
        .admin-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        .admin-input { padding: 10px; border: 1px solid #DDD; border-radius: 5px; font-size: 14px; }
        .order-box { border: 1px solid #EEE; padding: 15px; border-radius: 10px; margin-bottom: 12px; background: #FAFAFA; border-left: 5px solid var(--matcha); }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #EEE; padding: 10px; text-align: left; }
        th { background: var(--matcha); color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="hall-screen" class="hall">
        <h1 style="color:var(--matcha); margin-bottom: 10px;">33 æ—¥æœ¬å‹•ç‰©åœ’</h1>
        <p style="color: #666; margin-bottom: 30px;">åœ’é•·æ¡è³¼é€£ç·šä¸­ ğŸ‡¯ğŸ‡µ</p>
        <button onclick="openQuery()" style="background:var(--caramel); color:white; border:none; padding:15px 40px; border-radius:30px; font-weight:bold; font-size: 16px; cursor:pointer; box-shadow: 0 4px 10px rgba(188,108,37,0.3);">ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚å–®</button>
        <div id="hall-grid" class="grid"></div>
        <div onclick="adminLogin()" style="margin-top:auto; padding-bottom: 20px; color:#CCC; cursor:pointer; font-size:12px;">ADMIN ACCESS</div>
    </div>

    <div id="main-app" class="container">
        <div id="prod-list" class="list"></div>
        <div class="cart-panel">
            <div id="cart-items">æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
            <div class="cart-ctrl">
                <p style="margin:5px 0;">ç¸½è¨ˆé‡‘é¡: <b style="color:var(--caramel); font-size:22px;">$ <span id="cart-total">0</span></b></p>
                <input id="nick" style="width:100%; padding:12px; border:1px solid #DDD; border-radius:6px; box-sizing:border-box; margin-bottom: 10px;" placeholder="è«‹è¼¸å…¥æ‚¨çš„ LINE æš±ç¨±">
                <button onclick="submitOrder()" style="width:100%; padding:14px; background:var(--caramel); color:white; border:none; border-radius:6px; font-weight:bold; font-size: 16px; cursor:pointer;">ç¢ºèªæäº¤è¨‚å–®</button>
                <button onclick="location.reload()" style="width:100%; margin-top:10px; background:none; border:none; color:#999; font-size:13px; cursor:pointer;">â† è¿”å›é¸æ“‡å…¶ä»–åˆ†é¡</button>
            </div>
        </div>
    </div>

    <div id="admin">
        <div class="admin-nav">
            <button id="tab1" class="active" onclick="tk(1)">ğŸ“¦ è¨‚å–®ç®¡ç†/çµ±è¨ˆ</button>
            <button id="tab2" onclick="tk(2)">ğŸ·ï¸ å•†å“ä¸Šæ¶/ç·¨è¼¯</button>
            <button onclick="document.getElementById('admin').style.display='none'">âŒ é€€å‡º</button>
        </div>
        <div class="admin-body">
            <div id="sec-1">
                <h3 style="color:var(--earth)">ğŸ“Š ç•¶å‰æ¡è³¼ç¸½æ•¸</h3>
                <div id="summary-report" style="overflow-x: auto;"></div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #EEE;">
                <h3 style="color:var(--earth)">ğŸ“œ å¾…è™•ç†è¨‚å–®</h3>
                <div id="active-orders"></div>
                <div style="opacity:0.5; margin-top:40px;"><h4>âœ… å·²å‡ºè²¨ç´€éŒ„</h4><div id="done-orders"></div></div>
            </div>
            <div id="sec-2" style="display:none">
                <div style="background:#FDFCF0; padding:20px; border:2px solid #D1C7A1; border-radius:12px; margin-bottom:25px;">
                    <b style="font-size:18px;">â• å¿«é€Ÿä¸Šæ¶å•†å“</b><br><br>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input id="add-n" class="admin-input" style="flex:2" placeholder="å“å"> 
                        <input id="add-p" class="admin-input" style="width:100px" type="number" placeholder="åƒ¹æ ¼">
                    </div>
                    <select id="add-e" class="admin-input" style="width:100%; margin-bottom:10px;">
                        <option>æ—¥æœ¬è¶…å¸‚</option>
                        <option>æ—¥æœ¬SS10å‘¨é‚Š</option>
                        <option>æ—¥æœ¬SS10è¿½åŠ </option>
                    </select>
                    <input id="add-s" class="admin-input" style="width:100%; margin-bottom:15px;" placeholder="è¦æ ¼æ¸…å–®(å¦‚: M,L æˆ– èµ«,æµ·)">
                    <button onclick="addProd()" style="width:100%; background:var(--matcha); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">ç™¼å¸ƒå•†å“</button>
                </div>
                <div id="admin-prod-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Firebase é…ç½® --- (è«‹ç¢ºä¿æ­¤è™•è³‡è¨Šæ­£ç¢º)
    const firebaseConfig = {
        apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
        authDomain: "zoo-62638.firebaseapp.com",
        databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
        projectId: "zoo-62638",
        storageBucket: "zoo-62638.firebasestorage.app",
        messagingSenderId: "33012710753",
        appId: "1:33012710753:web:318636add1f5ac2f7b5920"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let productsMap = {}, cart = [], curS = {}, curQty = {};

    db.ref('products').on('value', snap => {
        productsMap = snap.val() || {};
        renderHall();
        renderAdmin();
    });

    function renderHall() {
        const prods = Object.values(productsMap);
        const evts = [...new Set(prods.map(p => p.e))];
        document.getElementById('hall-grid').innerHTML = evts.map(e => `<div class="card" onclick="openShop('${e}')"><b>${e}</b></div>`).join('');
    }

    function openShop(e) {
        document.getElementById('hall-screen').style.display = 'none';
        document.getElementById('main-app').style.visibility = 'visible';
        let h = "";
        for(let id in productsMap) {
            const p = productsMap[id];
            if(p.e !== e) continue;
            if(!curQty[id]) curQty[id] = 1;
            h += `<div class="prod-card">
                <span class="prod-price">$${p.p}</span><b class="prod-title">${p.n}</b>
                <div class="spec-wrap">${p.s ? p.s.split(',').map(v=>`<button class="spec-btn" id="s-${id}-${v}" onclick="setS('${id}','${v}')">${v}</button>`).join('') : ''}</div>
                <div class="row">
                    <div class="qty-box"><button onclick="chgQ('${id}',-1)">-</button><span id="q-${id}">${curQty[id]}</span><button onclick="chgQ('${id}',1)">+</button></div>
                    <button class="add-btn" onclick="add('${id}')">åŠ å…¥è³¼ç‰©è»Š</button>
                </div>
            </div>`;
        }
        document.getElementById('prod-list').innerHTML = h;
    }

    function chgQ(id, d) { curQty[id] = Math.max(1, (curQty[id] || 1) + d); document.getElementById(`q-${id}`).innerText = curQty[id]; }
    function setS(id, v) { 
        curS[id] = v; 
        const p = document.getElementById(`s-${id}-${v}`).parentNode;
        p.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(`s-${id}-${v}`).classList.add('active'); 
    }

    function add(id) {
        const p = productsMap[id];
        if (p.s && !curS[id]) return alert("è«‹é¸è¦æ ¼ï¼");
        cart.push({...p, sel: curS[id] || "ä¸€èˆ¬", qty: curQty[id], tP: p.p * curQty[id]});
        renderCart();
    }

    function renderCart() {
        let t = 0;
        if(cart.length === 0) { document.getElementById('cart-items').innerText = "æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„"; }
        else {
            document.getElementById('cart-items').innerHTML = cart.map((it, i) => {
                t += it.tP;
                return `<div style="padding:8px 0; border-bottom:1px solid #f0f0f0;">${it.n}(${it.sel}) x${it.qty} <span style="float:right; font-weight:bold;">$${it.tP} <i onclick="cart.splice(${i},1);renderCart()" style="cursor:pointer; color:#ccc; margin-left:10px; font-style:normal;">âœ•</i></span></div>`;
            }).join('');
        }
        document.getElementById('cart-total').innerText = t;
    }

    function submitOrder() {
        const n = document.getElementById('nick').value.trim();
        if (!n) return alert("è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±ä»¥æ–¹ä¾¿å°å¸³å–”ï¼");
        if (cart.length === 0) return alert("è³¼ç‰©è»Šè£¡é‚„æ²’æœ‰æ±è¥¿å‘¢ï¼");
        db.ref('orders').push({ nick: n, items: cart, total: cart.reduce((a,b)=>a+b.tP,0), status: "å¾…å‡ºè²¨", note: "", time: new Date().toLocaleString() });
        alert("è¨‚å–®å·²é€é”åœ’é•·æ‰‹ä¸­ï¼âœ¨"); location.reload();
    }

    // --- å¾Œå°ç®¡ç†é‚è¼¯ ---
    function adminLogin() { if(prompt("åœ’é•·è«‹è¼¸å…¥å¯†ç¢¼ï¼š")==="1239") { document.getElementById('admin').style.display='flex'; loadAdminData(); } }
    function tk(idx) { [1,2].forEach(i => { document.getElementById('sec-'+i).style.display = i===idx?'block':'none'; document.getElementById('tab'+i).className = i===idx?'active':''; }); }

    function loadAdminData() {
        db.ref('orders').on('value', snap => {
            const data = snap.val();
            let activeH = "", doneH = "", sum = {};
            if(!data) { document.getElementById('active-orders').innerHTML = "ç›®å‰å°šç„¡è¨‚å–®"; return; }
            for(let k in data) {
                const o = data[k];
                const itemsStr = o.items.map(i=>`â€¢ ${i.n} [${i.sel}] x${i.qty}`).join('<br>');
                const h = `<div class="order-box">
                    <div style="display:flex; justify-content:space-between;"><b>ğŸ‘¤ ${o.nick}</b> <small style="color:#999;">${o.time}</small></div>
                    <div style="margin:10px 0; color:#444; line-height:1.5;">${itemsStr}</div>
                    <div style="font-weight:bold; color:var(--caramel); margin-bottom:10px;">ç¸½è¨ˆ: $${o.total}</div>
                    <div style="border-top:1px solid #EEE; padding-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                        ç‹€æ…‹: <select onchange="db.ref('orders/${k}').update({status:this.value})"><option ${o.status==='å¾…å‡ºè²¨'?'selected':''}>å¾…å‡ºè²¨</option><option ${o.status==='å·²å‡ºè²¨'?'selected':''}>å·²å‡ºè²¨</option></select>
                        å‚™è¨»: <input class="admin-input" style="flex:1; min-width:150px;" value="${o.note||''}" onchange="db.ref('orders/${k}').update({note:this.value})">
                        <button onclick="if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ')) db.ref('orders/${k}').remove()" style="background:none; border:none; color:red; cursor:pointer;">åˆªé™¤</button>
                    </div>
                </div>`;
                if(o.status === 'å·²å‡ºè²¨') doneH += h; else activeH += h;
                if(o.status !== 'å·²å‡ºè²¨') o.items.forEach(i => { let key = `${i.n} [${i.sel}]`; sum[key] = (sum[key] || 0) + i.qty; });
            }
            document.getElementById('active-orders').innerHTML = activeH || "ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®";
            document.getElementById('done-orders').innerHTML = doneH;
            
            let sH = `<table><tr><th>å•†å“èˆ‡è¦æ ¼</th><th>ç¸½éœ€æ±‚æ•¸</th></tr>`;
            for(let k in sum) sH += `<tr><td>${k}</td><td style="text-align:center; font-weight:bold; font-size:16px;">${sum[k]}</td></tr>`;
            document.getElementById('summary-report').innerHTML = sH + "</table>";
        });
    }

    function renderAdmin() {
        let h = "";
        for(let id in productsMap) {
            const p = productsMap[id];
            h += `<div style="padding:12px; border:1px solid #EEE; border-radius:8px; margin-bottom:8px; display:flex; flex-direction:column; gap:8px; background:#FFF;">
                <div style="display:flex; gap:8px;">
                    <span style="background:var(--matcha); color:white; padding:2px 6px; border-radius:4px; font-size:11px;">${p.e}</span>
                    <input class="admin-input" style="flex:2" value="${p.n}" onchange="db.ref('products/${id}').update({n:this.value})">
                    <input class="admin-input" style="width:80px" type="number" value="${p.p}" onchange="db.ref('products/${id}').update({p:parseInt(this.value)})">
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input class="admin-input" style="flex:1" value="${p.s||''}" placeholder="è¦æ ¼" onchange="db.ref('products/${id}').update({s:this.value})">
                    <button onclick="if(confirm('åˆªé™¤å•†å“ï¼Ÿ')) db.ref('products/${id}').remove()" style="color:red; border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }
        document.getElementById('admin-prod-list').innerHTML = h;
    }

    function addProd() {
        const n = document.getElementById('add-n').value, 
              p = parseInt(document.getElementById('add-p').value), 
              e = document.getElementById('add-e').value,
              s = document.getElementById('add-s').value;
        if(n && p) { 
            db.ref('products').push({ e, n, p, s: s || "" }); 
            document.getElementById('add-n').value=''; 
            document.getElementById('add-p').value=''; 
            document.getElementById('add-s').value='';
            alert("å•†å“å·²ä¸Šæ¶ï¼");
        } else { alert("å“åè·Ÿåƒ¹æ ¼è¦å¡«å–”ï¼"); }
    }

    function openQuery() {
        const n = prompt("è«‹è¼¸å…¥æ‚¨çš„ LINE æš±ç¨±ï¼š");
        if(!n) return;
        db.ref('orders').orderByChild('nick').equalTo(n).once('value', snap => {
            const d = snap.val();
            let h = `<div style="padding:20px; text-align:center;"><h2 style="color:var(--matcha)">${n} çš„è¨‚å–®è¨˜éŒ„</h2>`;
            if(!d) h += "<p>æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèªæš±ç¨±æ˜¯å¦æ­£ç¢ºã€‚</p>";
            else {
                for(let k in d) h += `<div style="background:#FFF9C4; padding:15px; border-radius:12px; margin-bottom:15px; text-align:left; border:1px solid #E6DB74;">
                    <small style="color:#888;">ä¸‹å–®æ™‚é–“: ${d[k].time}</small><br>
                    <div style="margin:10px 0; font-size:15px; line-height:1.6;">${d[k].items.map(i=>`â€¢ ${i.n}(${i.sel}) x${i.qty}`).join('<br>')}</div>
                    <div style="border-top:1px solid #E6DB74; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <b>ç¸½é¡: $${d[k].total}</b>
                        <span style="background:${d[k].status==='å¾…å‡ºè²¨'?'var(--caramel)':'#2d5a27'}; color:white; padding:4px 10px; border-radius:20px; font-size:12px;">${d[k].status}</span>
                    </div>
                    ${d[k].note ? `<div style="margin-top:8px; font-size:13px; color:#666;">ğŸ“ åœ’é•·å›è¦†: ${d[k].note}</div>` : ''}
                </div>`;
            }
            h += `<button onclick="location.reload()" style="width:100%; padding:15px; background:var(--matcha); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">è¿”å›é¦–é </button></div>`;
            document.getElementById('prod-list').innerHTML = h;
            document.getElementById('hall-screen').style.display = 'none';
            document.getElementById('main-app').style.visibility = 'visible';
        });
    }
</script>
</body>
</html>
