<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33 ä»£è³¼ç™»è¨˜</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #2c3e50; --accent: #003399; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #333; overflow-x: hidden; }
        
        /* å…¨åŸŸé ‚éƒ¨å°èˆª */
        header { 
            background: var(--main); color: white; padding: 15px; 
            text-align: center; font-weight: bold; font-size: 1.2em;
            position: sticky; top: 0; z-index: 8000; cursor: pointer;
        }

        /* å•†å“æ¸…å–®å€ */
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .item-card { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .price { color: var(--accent); font-weight: bold; }

        /* åº•éƒ¨å½ˆå‡ºç™»è¨˜å€ */
        #bottom-panel { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            padding: 20px; border-top: 1px solid #ddd; box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            display: none; flex-direction: column; gap: 12px; z-index: 6000;
        }
        .input-box { padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1em; width: 100%; box-sizing: border-box; }

        /* å³æ™‚çœ‹æ¿å€ (ä¸€é å¼æ ¸å¿ƒ) */
        .board-container { padding: 15px; max-width: 600px; margin: 20px auto 150px auto; background: #fff; border-radius: 15px; border: 1px solid #eee; }
        .board-title { font-weight: bold; margin-bottom: 15px; padding-left: 10px; border-left: 5px solid var(--main); }

        /* å…¨è¢å¹•ç®¡ç†é¢æ¿ */
        .full-panel { 
            position: fixed; inset: 0; background: white; z-index: 9000; 
            display: none; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag { padding: 3px 8px; border-radius: 5px; font-size: 0.75em; color: white; margin-left: 5px; font-weight: bold; }
        .tag-ok { background: #4caf50; }
        .tag-wait { background: #ff9800; }

        /* éš±è—è€é—†å…¥å£ */
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; color: #e0e0e0; font-size: 0.8em; cursor: pointer; padding: 10px; z-index: 1000; }
    </style>
</head>
<body>

<header onclick="location.reload()">ğŸ’™ 33 ä»£è³¼ç™»è¨˜</header>

<div class="container">
    <div style="margin: 10px 0; font-size: 0.9em; color: #666;">ğŸ“Œ é»æ“Šä¸‹æ–¹å“é …å³å¯é–‹å§‹ç™»è¨˜ï¼š</div>
    <div id="main-item-list">è®€å–ä¸­...</div>
</div>

<div class="board-container">
    <div class="board-title">ğŸ“Š å³æ™‚ç™»è¨˜çœ‹æ¿ (é †ä½/å€™è£œ)</div>
    <div id="live-board">ç›®å‰å°šç„¡ç™»è¨˜è³‡æ–™</div>
</div>

<div id="bottom-panel">
    <div style="font-weight: bold; color: var(--accent); font-size: 1.1em;" id="target-name">å•†å“åç¨±</div>
    <div style="display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <span>ç™»è¨˜æ•¸é‡ï¼š</span>
        <input type="number" id="target-qty" value="1" min="1" style="width: 80px; padding: 8px; text-align: center; border-radius: 5px; border: 1px solid #ddd; font-weight: bold;">
    </div>
    <input type="text" id="user-nick" class="input-box" placeholder="è«‹è¼¸å…¥ç™»è¨˜æš±ç¨± (å¿…å¡«)">
    <div style="display: flex; gap: 10px;">
        <button onclick="submitData()" style="flex: 2; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer;">ç¢ºèªé€å‡º</button>
        <button onclick="closeBottom()" style="flex: 1; padding: 15px; background: #eee; border: none; border-radius: 10px; cursor: pointer;">å–æ¶ˆ</button>
    </div>
</div>

<div class="admin-trigger" onclick="adminLogin()">.</div>

<div id="admin-panel" class="full-panel">
    <div class="panel-header">
        <h3>âš™ï¸ è€é—†ç®¡ç†å¾Œå°</h3>
        <button onclick="closePanel('admin-panel')" style="border:none; background:none; font-size:1.5em;">âœ•</button>
    </div>
    <div style="background:#e7f3ff; padding:15px; border-radius:10px; margin-bottom:20px;">
        <strong>å¿«é€Ÿåˆå§‹åŒ– (SS10 æ—¥æœ¬é€±é‚Š)ï¼š</strong><br>
        <button onclick="seedSS10()" style="width:100%; padding:12px; margin-top:10px; background:#007bff; color:white; border:none; border-radius:8px;">ğŸ”„ ä¸€éµä¸Šæ¶ SS10 é€±é‚Šå“é …</button>
    </div>
    <div id="adm-history"></div>
</div>

<script>
// --- Firebase è¨­å®š ---
const firebaseConfig = {
    apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
    authDomain: "zoo-62638.firebaseapp.com",
    databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
    projectId: "zoo-62638",
    storageBucket: "zoo-62638.firebasestorage.app",
    messagingSenderId: "33012710753",
    appId: "1:33012710753:web:318636add1f5ac2f7b5920"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let items = [];
let orders = {};
let activeItem = null;

// --- ä»‹é¢åŠŸèƒ½ ---
function openPanel(id) { document.getElementById(id).style.display = 'flex'; }
function closePanel(id) { document.getElementById(id).style.display = 'none'; }
function adminLogin() {
    const p = prompt("ç®¡ç†ç™»å…¥ï¼š");
    if(p === "3388") openPanel('admin-panel');
}

// --- å•†å“åˆå§‹åŒ– (SS10 æ—¥æœ¬é€±é‚Šç¯„ä¾‹) ---
function seedSS10() {
    const sj = [
        { id: 201, sort: 1, name: "SS10 æ‰‹ç‡ˆ (5500å††)", price: 1350, stock: 5 },
        { id: 202, sort: 2, name: "SS10 æ¯›å·¾ (2100å††)", price: 550, stock: 10 },
        { id: 203, sort: 3, name: "SS10 éš¨æ©Ÿå°å¡ (600å††)", price: 160, stock: 50 },
        { id: 204, sort: 4, name: "SS10 æ‰˜ç‰¹åŒ… (2500å††)", price: 650, stock: 5 },
        { id: 205, sort: 5, name: "æ—¥æœ¬è¶…å¸‚-æŸæŸé›¶é£Ÿ", price: 100, stock: 20 }
    ];
    if(confirm("å°‡ä¸Šæ¶ SS10 é€±é‚Šå“é …ï¼Œç¢ºå®šå—ï¼Ÿ")) {
        db.ref("products").set(sj).then(() => alert("å•†å“å·²æ›´æ–°ï¼è«‹åœ¨å¾Œå°ä¿®æ”¹æ‚¨æƒ³è¦çš„å°å¹£åƒ¹æ ¼ã€‚"));
    }
}

// --- è³‡æ–™ç›£è½èˆ‡æ¸²æŸ“ ---
db.ref("products").on("value", (s) => {
    items = s.val() || [];
    items.sort((a,b) => a.sort - b.sort);
    const listDiv = document.getElementById('main-item-list');
    listDiv.innerHTML = items.map(i => `
        <div class="item-card" onclick="startOrder(${i.id})">
            <div>
                <div style="font-weight:bold;">${i.name}</div>
                <div class="price">NT$ ${i.price}</div>
            </div>
            <div style="font-size:0.8em; color:#999;">é™é¡ ${i.stock}</div>
        </div>
    `).join('') || "ç›®å‰ç„¡å•†å“ï¼Œè«‹é€²å¾Œå°åˆå§‹åŒ–ã€‚";
    renderLiveBoard(); 
});

db.ref("history").on("value", (s) => {
    orders = s.val() || {};
    renderLiveBoard();
    renderAdminHistory();
});

// --- ç™»è¨˜é‚è¼¯ ---
function startOrder(id) {
    activeItem = items.find(i => i.id === id);
    document.getElementById('target-name').innerText = "ç™»è¨˜é …ç›®ï¼š" + activeItem.name;
    document.getElementById('target-qty').value = 1;
    document.getElementById('bottom-panel').style.display = 'flex';
}

function closeBottom() {
    document.getElementById('bottom-panel').style.display = 'none';
}

async function submitData() {
    const nick = document.getElementById('user-nick').value.trim();
    const qty = parseInt(document.getElementById('target-qty').value);
    if(!nick || qty < 1) return alert("è«‹å®Œæ•´å¡«å¯«æš±ç¨±èˆ‡æ•¸é‡");

    const data = {
        time: new Date().toLocaleString(),
        timestamp: Date.now(),
        items: [{ name: activeItem.name, qty: qty }],
        note: nick
    };

    await db.ref("history").push(data);
    alert("âœ… ç™»è¨˜æˆåŠŸï¼è«‹æŸ¥çœ‹ä¸‹æ–¹çœ‹æ¿ã€‚");
    closeBottom();
    document.getElementById('user-nick').value = "";
}

// --- é †ä½è¨ˆç®—é‚è¼¯ ---
function calculateTag(orderKey, itemName) {
    const list = Object.keys(orders).map(k => ({k, ...orders[k]}))
        .filter(o => o.items.some(i => i.name === itemName))
        .sort((a,b) => a.timestamp - b.timestamp);
    
    let current = 0;
    const limit = (items.find(i => i.name === itemName) || {}).stock || 0;
    
    for (let o of list) {
        const it = o.items.find(i => i.name === itemName);
        const start = current + 1;
        current += it.qty;
        
        if(o.k === orderKey) {
            if (start <= limit) return `<span class="tag tag-ok">é †ä½ ${start}</span>`;
            else return `<span class="tag tag-wait">å€™è£œ ${start - limit}</span>`;
        }
    }
    return "";
}

// --- å³æ™‚çœ‹æ¿æ¸²æŸ“ (å…¨é«”å…¬é–‹) ---
function renderLiveBoard() {
    const board = document.getElementById('live-board');
    const sorted = Object.keys(orders).sort((a,b) => orders[b].timestamp - orders[a].timestamp);
    
    if(sorted.length === 0) {
        board.innerHTML = "<div style='color:#ccc; text-align:center;'>å°šæœªæœ‰ç™»è¨˜ç´€éŒ„</div>";
        return;
    }

    board.innerHTML = sorted.map(k => `
        <div style="background:#fcfcfc; padding:12px; border-radius:10px; margin-bottom:8px; border:1px solid #f0f0f0; font-size:0.95em;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; color:var(--main);">${orders[k].note}</span>
                <span style="font-size:0.75em; color:#bbb;">${orders[k].time}</span>
            </div>
            <div style="margin-top:5px;">
                ${orders[k].items.map(i => `<span>${i.name} x ${i.qty}</span> ${calculateTag(k, i.name)}`).join('')}
            </div>
        </div>
    `).join('');
}

// --- ç®¡ç†æ­·å²æ¸²æŸ“ ---
function renderAdminHistory() {
    const div = document.getElementById('adm-history');
    const sorted = Object.keys(orders).sort((a,b) => orders[a].timestamp - orders[b].timestamp);
    div.innerHTML = sorted.map(k => `
        <div style="border-bottom:1px solid #eee; padding:10px; font-size:0.9em;">
            <strong>${orders[k].note}</strong> <small>(${orders[k].time})</small>
            <button onclick="delOrder('${k}')" style="float:right; color:red; border:none; background:none; cursor:pointer;">âœ•</button>
            <br>${orders[k].items.map(i => `${i.name} x ${i.qty} ${calculateTag(k, i.name)}`).join('')}
        </div>
    `).join('');
}

function delOrder(k) {
    if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç™»è¨˜ï¼Ÿ")) db.ref("history").child(k).remove();
}
</script>
</body>
</html>
