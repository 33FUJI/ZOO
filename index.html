<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>33æ—¥æœ¬å‹•ç‰©åœ’</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root{--bg:#fdfaf5;--blue:#003399;--red:#d9534f;--gold:#b5a491}
        body{font-family:sans-serif;background:var(--bg);margin:0;padding-bottom:180px;color:#333}
        header{padding:20px;text-align:center;font-weight:bold;color:var(--gold);font-size:1.4em;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
        .top-section{padding:15px;background:#fff;margin-bottom:10px}
        .nick-input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;box-sizing:border-box;font-size:16px}
        .cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:10px 15px}
        .cat-card{background:#fff;padding:30px 10px;border-radius:15px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.05);cursor:pointer;border:1px solid #eee;font-weight:bold}
        .modal{position:fixed;inset:0;background:var(--bg);z-index:9999;display:none;flex-direction:column}
        .modal-header{padding:15px;background:#fff;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee}
        .p-group{background:#fff;margin:10px 15px;border-radius:10px;border:1px solid #eee;overflow:hidden}
        .p-header{padding:10px 15px;font-weight:bold;background:#fafafa;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
        .spec-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #f9f9f9}
        .qty-controls{display:flex;align-items:center;gap:12px;flex-shrink:0}
        .qty-btn{width:38px;height:38px;border-radius:8px;border:none;background:#eee;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center}
        .order-area{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:15px;border-radius:20px 20px 0 0;box-shadow:0 -5px 20px rgba(0,0,0,0.15);z-index:10000;border-top:2px solid var(--blue)}
        .submit-btn{width:100%;padding:15px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-weight:bold;cursor:pointer;font-size:1.1em;margin-top:10px}
        .cart-detail{max-height:80px;overflow-y:auto;font-size:0.85em;margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:5px}
        .admin-box{padding:15px;background:#fff;margin:10px;border-radius:10px;border:1px solid #ddd}
        table{width:100%;border-collapse:collapse;font-size:0.8em;margin-top:10px;background:#fff}
        th,td{border:1px solid #eee;padding:10px;text-align:left}
    </style>
</head>
<body>

<header>âœ¨ 33æ—¥æœ¬å‹•ç‰©åœ’ âœ¨</header>

<div class="top-section">
    <input type="text" id="user-nick" class="nick-input" placeholder="âœ è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±">
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button onclick="fetchHistory()" style="background:none; border:none; color:var(--blue); text-decoration:underline; font-size:0.9em; cursor:pointer;">ğŸ” æŸ¥è©¢æˆ‘çš„ç™»è¨˜ç´€éŒ„</button>
        <button id="admin-trigger" onclick="toggleAdmin()" style="display:none; background:var(--gold); border:none; color:white; padding:5px 12px; border-radius:5px; font-size:0.8em;">ğŸ›  ç®¡ç†è€…ä»‹é¢</button>
    </div>
</div>

<div class="cat-grid" id="main-grid"></div>

<div id="admin-area" style="display:none; padding-bottom:100px;">
    <div class="admin-box">
        <h3>â• æ–°å¢å•†å“</h3>
        <input id="ad-cat" style="width:100%;margin-bottom:5px;" placeholder="åˆ†é¡ (ä¾‹å¦‚: SS10é€±é‚Š)">
        <input id="ad-name" style="width:100%;margin-bottom:5px;" placeholder="åç¨± (ä¾‹å¦‚: 01 Tæ¤)">
        <input id="ad-price" style="width:100%;margin-bottom:5px;" type="number" placeholder="åƒ¹æ ¼">
        <input id="ad-spec" style="width:100%;margin-bottom:10px;" placeholder="è¦æ ¼ (ç”¨é€—è™Ÿéš”é–‹)">
        <button onclick="saveProduct()" style="width:100%; background:#28a745; color:#fff; padding:10px; border:none; border-radius:5px;">ç¢ºèªä¸Šæ¶</button>
    </div>
    <div class="admin-box">
        <h3>ğŸ“‹ æ‰€æœ‰è¨‚å–®åŒ¯ç¸½</h3>
        <button onclick="loadAllOrders()">åˆ·æ–°åˆ—è¡¨</button>
        <button onclick="clearSystem()" style="color:red; float:right; border:none; background:none;">âš ï¸ ç³»çµ±é‡è¨­(æ¸…ç©ºè³‡æ–™)</button>
        <div id="order-table" style="overflow-x:auto; margin-top:10px;"></div>
    </div>
</div>

<div id="history-modal" class="modal">
    <div class="modal-header"><span onclick="closeHistory()" style="cursor:pointer;font-weight:bold;color:var(--blue)">â® è¿”å›</span><h2 style="font-size:1.1em;margin:0">æ­·å²ç™»è¨˜ç´€éŒ„</h2><div></div></div>
    <div id="history-list" style="overflow-y:auto;flex:1;padding:10px;"></div>
</div>

<div id="item-modal" class="modal">
    <div class="modal-header"><span onclick="closeModal()" style="cursor:pointer;font-weight:bold;color:var(--blue)">â® è¿”å›</span><h2 id="cat-title" style="font-size:1.1em;margin:0"></h2><div></div></div>
    <div id="p-list" style="overflow-y:auto;flex:1"></div>
</div>

<div class="order-area" id="order-bar" style="display:none">
    <div id="cart-list" class="cart-detail"></div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:0.8em; color:#999;" onclick="clearCart()">ğŸ—‘ï¸ æ¸…ç©º</div>
        <div style="text-align:right; font-weight:bold; color:var(--red); font-size:1.4em;">ç¸½è¨ˆ $<span id="total-val">0</span></div>
    </div>
    <button class="submit-btn" onclick="submitOrder()">âœ… ç¢ºèªç™»è¨˜ä¸‹å–®</button>
</div>

<script>
var config={apiKey:"AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",databaseURL:"https://zoo-62638-default-rtdb.firebaseio.com",projectId:"zoo-62638"};
if (!firebase.apps.length) { firebase.initializeApp(config); }
var db = firebase.database();
var cart = {}, cloudData = {};

// æª¢æŸ¥ç®¡ç†å“¡éš±è—æŒ‰éˆ•
document.getElementById('user-nick').addEventListener('input', function(e){
    document.getElementById('admin-trigger').style.display = (e.target.value === '1239') ? 'block' : 'none';
});

function toggleAdmin(){
    var x = document.getElementById('admin-area');
    x.style.display = (x.style.display==='none') ? 'block' : 'none';
    if(x.style.display==='block') loadAllOrders();
}

// ä¿®æ­£å¾Œçš„è³‡æ–™ç›£è½ï¼šæ’é™¤éš¨æ©Ÿ IDï¼Œç¢ºä¿åªé¡¯ç¤ºåˆ†é¡åç¨±
db.ref('products').on('value', function(sn){
    cloudData = sn.val() || {};
    var grid = document.getElementById('main-grid');
    grid.innerHTML = '';
    Object.keys(cloudData).forEach(function(key){
        // åªæœ‰ç•¶ key åº•ä¸‹é‚„æœ‰ç‰©ä»¶ï¼ˆä»£è¡¨å®ƒæ˜¯åˆ†é¡åç¨±ï¼‰æ™‚æ‰é¡¯ç¤º
        if (typeof cloudData[key] === 'object' && !key.startsWith('-')) {
            grid.innerHTML += '<div class="cat-card" onclick="openCat(\''+key+'\')">'+key+'</div>';
        }
    });
});

function openCat(cat){
    document.getElementById('cat-title').innerText = cat;
    var list = document.getElementById('p-list'); list.innerHTML = '';
    var items = cloudData[cat];
    Object.keys(items).forEach(function(id){
        var p = items[id];
        var specs = (p.s || "å–®ä¸€è¦æ ¼").split(',');
        var specHtml = specs.map(function(s){
            var k = cat + '|' + id + '|' + s.trim();
            return '<div class="spec-item"><span>'+s.trim()+'</span><div class="qty-controls"><button class="qty-btn" onclick="updateQty(\''+k+'\',-1)">-</button><span id="num-'+k+'" style="min-width:30px;text-align:center">'+(cart[k]||0)+'</span><button class="qty-btn" onclick="updateQty(\''+k+'\',1)">+</button></div></div>';
        }).join('');
        list.innerHTML += '<div class="p-group"><div class="p-header"><span>'+p.n+'</span><span style="color:var(--red)">$'+p.p+'</span></div>'+specHtml+'</div>';
    });
    document.getElementById('item-modal').style.display = 'flex';
}

function updateQty(k, d){
    cart[k] = (cart[k] || 0) + d;
    if(cart[k] <= 0) delete cart[k];
    var el = document.getElementById('num-'+k); if(el) el.innerText = cart[k]||0;
    updateCartUI();
}

function updateCartUI(){
    var bar = document.getElementById('order-bar'), list = document.getElementById('cart-list'), keys = Object.keys(cart);
    if(!keys.length){ bar.style.display='none'; return; }
    bar.style.display='block'; list.innerHTML = ''; var total = 0;
    keys.forEach(function(k){
        var p = k.split('|'); var info = cloudData[p[0]][p[1]];
        total += info.p * cart[k];
        list.innerHTML += '<div style="display:flex;justify-content:space-between"><span>'+info.n+' ('+p[2]+')</span><span>x'+cart[k]+'</span></div>';
    });
    document.getElementById('total-val').innerText = total;
}

function submitOrder(){
    var nick = document.getElementById('user-nick').value;
    if(!nick || nick==='1239') return alert("è«‹è¼¸å…¥æš±ç¨±");
    db.ref('orders').push({nick:nick, time:new Date().toLocaleString(), items:cart, total:document.getElementById('total-val').innerText})
    .then(function(){ alert("âœ… ç™»è¨˜æˆåŠŸï¼"); clearCart(); });
}

function fetchHistory(){
    var nick = document.getElementById('user-nick').value;
    if(!nick || nick==='1239') return alert("è«‹å…ˆè¼¸å…¥æ‚¨çš„æš±ç¨±");
    var list = document.getElementById('history-list'); list.innerHTML = "æŸ¥è©¢ä¸­...";
    document.getElementById('history-modal').style.display = 'flex';
    db.ref('orders').orderByChild('nick').equalTo(nick).once('value', function(sn){
        list.innerHTML = "";
        if(!sn.exists()) { list.innerHTML = "ç„¡ç´€éŒ„"; return; }
        sn.forEach(function(d){
            var v = d.val(); var detail = "";
            Object.keys(v.items).forEach(function(k){ detail += '<div>â–ªï¸ ' + k.split('|')[0] + '-' + k.split('|')[2] + ' x' + v.items[k] + '</div>'; });
            list.innerHTML += '<div class="admin-box"><small>'+v.time+'</small><div>'+detail+'</div><div style="text-align:right;color:var(--red)">$'+v.total+'</div></div>';
        });
