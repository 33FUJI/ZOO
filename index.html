<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33 æ—¥æœ¬å‹•ç‰©åœ’ - åœ’é•·ä½œæ¥­ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ä¿æŒåŸæœ¬çš„é…è‰²é¢¨æ ¼ï¼Œå¢åŠ æ‰‹æ©Ÿç«¯æ»¾å‹•å„ªåŒ– */
        :root { --bg-rice: #FEF9EF; --matcha: #606C38; --caramel: #BC6C25; --dark-wood: #283618; --soft-white: #FFFFFF; }
        * { box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-rice); color: var(--dark-wood); margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
        
        /* å°èˆªåˆ—èˆ‡æ’ç‰ˆ */
        .top-nav { background: var(--soft-white); padding: 10px 15px; border-bottom: 2px solid #E9E2D0; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .product-pane { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; margin-left: 5px; }
        .bg-ok { background: #DDA15E; color: #FFF; } /* æ­£å– */
        .bg-wait { background: #E9E2D0; color: #666; } /* å€™è£œ */
        .bg-force { background: #606C38; color: #FFF; } /* å¼·åˆ¶æ­£å– */

        /* æ‰‹æ©Ÿç«¯å´é‚Šæ¬„è‡ªå‹•åˆ‡æ› */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .cart-sidebar { width: 100% !important; height: 40%; border-left: none !important; border-top: 2px solid #E9E2D0; }
            .event-grid { grid-template-columns: 1fr 1fr !important; }
        }

        /* è³¼ç‰©è»Šèˆ‡æŒ‰éˆ• */
        .cart-sidebar { width: 350px; background: #FFF; border-left: 2px solid #E9E2D0; padding: 20px; display: flex; flex-direction: column; }
        .btn-action { background: var(--matcha); color: #FFF; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .input-standard { width: 100%; padding: 12px; border: 2px solid #E9E2D0; border-radius: 10px; margin-bottom: 10px; }
        
        /* å¤§å»³èˆ‡å½ˆçª— */
        #hall-screen { position: fixed; inset: 0; background: var(--bg-rice); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .event-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 600px; }
        .event-card { background: #FFF; padding: 30px 10px; border-radius: 20px; text-align: center; border: 2px solid #E9E2D0; box-shadow: 0 4px 0 #E9E2D0; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #FFF; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; }
    </style>
</head>
<body>

<div id="hall-screen">
    <h2 style="color:var(--matcha)">33 æ—¥æœ¬å‹•ç‰©åœ’</h2>
    <div id="hall-grid" class="event-grid"></div>
    <button class="btn-action" style="margin-top:30px; width:250px;" onclick="openSearch()">ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚å–®ç´€éŒ„</button>
    <div onclick="adminAuth()" style="margin-top:50px; color:rgba(0,0,0,0.05); font-size:10px;">ADMIN LOGIN</div>
</div>

<header class="top-nav">
    <b onclick="goHall()" style="color:var(--matcha)">33 æ—¥æœ¬å‹•ç‰©åœ’</b>
    <span id="cur-evt"></span>
    <button onclick="goHall()" style="background:#EEE; border:none; padding:5px 10px; border-radius:5px;">å›å¤§å»³</button>
</header>

<div class="app-container">
    <div id="prod-list" class="product-pane"></div>
    
    <div class="cart-sidebar">
        <h4 style="margin:0 0 10px 0;">ğŸ›’ é¸è³¼æ¸…å–®</h4>
        <div id="cart-items" style="flex:1; overflow-y:auto;"></div>
        <div style="border-top:2px solid var(--matcha); padding-top:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>ç¸½è¨ˆ</span><b id="cart-total" style="color:var(--caramel)">0</b>
            </div>
            <input id="cust-nick" class="input-standard" placeholder="è¼¸å…¥ Line æš±ç¨±">
            <button class="btn-action" style="width:100%; background:var(--caramel);" onclick="submitOrder()">æäº¤è¨‚å–®</button>
        </div>
    </div>
</div>

<div id="search-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ” æŸ¥è©¢è¨‚å–®</h3>
        <input id="search-nick" class="input-standard" placeholder="è«‹è¼¸å…¥ Line æš±ç¨±">
        <div id="search-result" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        <button class="btn-action" style="width:100%" onclick="doSearch()">æœå°‹</button>
        <button class="btn-action" style="width:100%; background:#BBB; margin-top:10px;" onclick="closeSearch()">é—œé–‰</button>
    </div>
</div>

<div id="admin-panel" style="position:fixed; inset:0; background:#FFF; z-index:3000; display:none; flex-direction:column;">
    <div style="background:var(--matcha); color:#FFF; padding:15px; display:flex; justify-content:space-between;">
        <b>åœ’é•· 33 å¾Œå°</b>
        <button onclick="location.reload()">é€€å‡º</button>
    </div>
    <div style="padding:10px; background:#F0F0F0; display:flex; gap:5px;">
        <button onclick="renderAdmin('orders')">è¨‚å–®</button>
        <button onclick="renderAdmin('prods')">å•†å“</button>
    </div>
    <div id="admin-main" style="flex:1; overflow-y:auto; padding:15px;"></div>
</div>

<div id="qty-modal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 id="qty-n"></h3>
        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin:20px 0;">
            <button class="btn-action" onclick="changeQty(-1)">-</button>
            <b id="qty-v" style="font-size:2em;">1</b>
            <button class="btn-action" onclick="changeQty(1)">+</button>
        </div>
        <button class="btn-action" style="width:100%;" onclick="confirmAdd()">åŠ å…¥è³¼ç‰©è»Š</button>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content" id="edit-content"></div>
</div>

<script>
    // 1. åˆå§‹åŒ–è³‡æ–™ (å»ºè­°ç‰ˆæœ¬è™Ÿ v13 ä»¥å…è·ŸèˆŠçš„è¡çª)
    const KEY_P = 'zoo_p_v13';
    const KEY_O = 'zoo_o_v13';
    
    let products = JSON.parse(localStorage.getItem(KEY_P)) || [
        {e:"æ—¥æœ¬è¶…å¸‚", n:"å‹•ç‰©æ£’æ£’ç³–åŠé£¾", p:500, s:"ç‰¹,æ¾ˆ,é›²,ç«¥,èµ«,æµ·,æº,æ—­,åœ­", l:5},
        {e:"æ—¥æœ¬è¶…å¸‚", n:"å£“å…‹åŠ›ç«‹ç‰Œ", p:700, s:"ç‰¹,æ¾ˆ,é›²,ç«¥,èµ«,æµ·,æº,æ—­,åœ­", l:3}
    ];
    let orders = JSON.parse(localStorage.getItem(KEY_O)) || [];
    let cart = [], tempItem = null, curSel = {};

    function save() {
        localStorage.setItem(KEY_P, JSON.stringify(products));
        localStorage.setItem(KEY_O, JSON.stringify(orders));
    }

    // 2. è‡ªå‹•åˆ¤æ–·é‚è¼¯ (é—œéµï¼šåˆ¤æ–·æ­£å–/å€™è£œ)
    function getStatusTag(prodName, spec, itemTs, isForceOk) {
        if(isForceOk) return `<span class="badge bg-force">æ­£å–(ç¾è²¨)</span>`;
        
        const p = products.find(x => x.n === prodName);
        if(!p || !p.l) return ""; // ç„¡é™é¡çš„ä¸é¡¯ç¤º

        // æ’ˆå‡ºæ‰€æœ‰åŒ…å«æ­¤å•†å“çš„è¨‚å–®ï¼Œä¸¦ä¾æ™‚é–“æ’åº
        let queue = [];
        orders.forEach(o => {
            o.items.forEach(it => {
                if(it.n === prodName && it.sel === spec) {
                    queue.push({ ts: it.ts, force: it.forceOk });
                }
            });
        });
        queue.sort((a,b) => a.ts - b.ts);

        const idx = queue.findIndex(q => q.ts === itemTs);
        if(idx === -1) return "";
        
        return (idx < p.l) 
            ? `<span class="badge bg-ok">æ­£å– ${idx+1}</span>` 
            : `<span class="badge bg-wait">å€™è£œ ${idx + 1 - p.l}</span>`;
    }

    // 3. UI æ¸²æŸ“åŠŸèƒ½
    function goHall() {
        document.getElementById('hall-screen').style.display = 'flex';
        const evts = [...new Set(products.map(p => p.e))];
        document.getElementById('hall-grid').innerHTML = evts.map(e => `
            <div class="event-card" onclick="openShop('${e}')"><h3>${e}</h3></div>
        `).join('');
    }

    function openShop(e) {
        document.getElementById('hall-screen').style.display = 'none';
        document.getElementById('cur-evt').innerText = e;
        const list = products.filter(p => p.e === e);
        document.getElementById('prod-list').innerHTML = list.map((p, idx) => {
            const pid = products.indexOf(p);
            return `
                <div style="background:#FFF; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #E9E2D0;">
                    <b>${p.n}</b> <span style="color:var(--caramel)">$${p.p}</span>
                    <div style="font-size:0.8em; color:#999;">é™è³¼: ${p.l || 'ç„¡é™åˆ¶'}</div>
                    ${p.s ? `<div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;">
                        ${p.s.split(',').map(v => `<button id="btn-${pid}-${v}" class="btn-spec" style="padding:5px 10px; border:1px solid #DDD; border-radius:5px; background:#FFF;" onclick="selectSpec(${pid},'${v}')">${v}</button>`).join('')}
                    </div>` : ''}
                    <button class="btn-action" style="width:100%; margin-top:10px;" onclick="preAdd(${pid})">åŠ å…¥è³¼ç‰©è»Š</button>
                </div>
            `;
        }).join('');
    }

    function selectSpec(pid, v) {
        const p = products[pid];
        p.s.split(',').forEach(s => {
            const b = document.getElementById(`btn-${pid}-${s}`);
            if(b) b.style.background = (s === v) ? '#606C38' : '#FFF';
            if(b) b.style.color = (s === v) ? '#FFF' : '#333';
        });
        curSel[pid] = v;
    }

    function preAdd(pid) {
        const p = products[pid];
        if(p.s && !curSel[pid]) return alert("è«‹å…ˆé¸æ“‡è¦æ ¼ (æˆå“¡/å°ºå¯¸)");
        tempItem = { pid: pid, sel: curSel[pid] || "ä¸€èˆ¬", q: 1 };
        document.getElementById('qty-n').innerText = p.n;
        document.getElementById('qty-v').innerText = "1";
        document.getElementById('qty-modal').style.display = 'flex';
    }

    function changeQty(v) {
        tempItem.q = Math.max(1, tempItem.q + v);
        document.getElementById('qty-v').innerText = tempItem.q;
    }

    function confirmAdd() {
        const p = products[tempItem.pid];
        for(let i=0; i<tempItem.q; i++) {
            cart.push({ n: p.n, p: p.p, sel: tempItem.sel, ts: Date.now() + i, forceOk: false });
        }
        renderCart();
        document.getElementById('qty-modal').style.display = 'none';
    }

    function renderCart() {
        let total = 0;
        document.getElementById('cart-items').innerHTML = cart.map((it, i) => {
            total += it.p;
            return `<div style="padding:5px 0; border-bottom:1px solid #EEE; font-size:0.9em;">
                ${it.n}(${it.sel}) $${it.p} <span onclick="cart.splice(${i},1);renderCart()" style="float:right; color:red;">âœ•</span>
            </div>`;
        }).join('');
        document.getElementById('cart-total').innerText = total.toLocaleString();
    }

    function submitOrder() {
        const nick = document.getElementById('cust-nick').value.trim();
        if(!nick || !cart.length) return alert("è«‹è¼¸å…¥æš±ç¨±ä¸¦é¸æ“‡å•†å“");
        orders.push({
            nick: nick,
            items: [...cart],
            total: parseInt(document.getElementById('cart-total').innerText.replace(/,/g,'')),
            time: new Date().toLocaleString(),
            payStatus: "æœªä»˜æ¬¾"
        });
        save();
        alert("è¨‚å–®å·²é€å‡ºï¼åœ’é•·æœƒå†èˆ‡æ‚¨ç¢ºèª");
        cart = []; renderCart();
        document.getElementById('cust-nick').value = "";
    }

    // 4. ä½¿ç”¨è€…æŸ¥è©¢åŠŸèƒ½
    function doSearch() {
        const nick = document.getElementById('search-nick').value.trim();
        const myOrders = orders.filter(o => o.nick === nick);
        document.getElementById('search-result').innerHTML = myOrders.length ? myOrders.map(o => `
            <div style="border:1px solid #E9E2D0; padding:10px; border-radius:10px; margin-bottom:10px; background:#FAFAFA;">
                <div style="font-size:0.7em; color:#999;">${o.time} [${o.payStatus}]</div>
                ${o.items.map(it => `<div>â€¢ ${it.n}(${it.sel}) ${getStatusTag(it.n, it.sel, it.ts, it.forceOk)}</div>`).join('')}
                <div style="text-align:right; font-weight:bold; color:var(--caramel);">NT$ ${o.total}</div>
            </div>
        `).join('') : "æ‰¾ä¸åˆ°ç´€éŒ„å”·ï¼";
    }

    // 5. åœ’é•·å¾Œå°ç®¡ç† (å¼·åˆ¶æ­£å–å°±åœ¨é€™ï¼)
    function adminAuth() {
        if(prompt("åœ’é•·é©—è­‰ç¢¼") === "1239") {
            document.getElementById('admin-panel').style.display = 'flex';
            renderAdmin('orders');
        }
    }

    function renderAdmin(mode) {
        const container = document.getElementById('admin-main');
        if(mode === 'orders') {
            container.innerHTML = orders.map((o, i) => `
                <div style="border-bottom:2px solid #EEE; padding:10px 0;">
                    <b>${o.nick}</b> ($${o.total})
                    ${o.items.map((it, ii) => `
                        <div style="font-size:0.85em; display:flex; justify-content:space-between; align-items:center; margin:5px 0;">
                            <span>â€¢ ${it.n}(${it.sel})</span>
                            <label><input type="checkbox" ${it.forceOk?'checked':''} onchange="toggleForce(${i},${ii},this.checked)"> å¼·åˆ¶æ­£å–</label>
                        </div>
                    `).join('')}
                    <button onclick="if(confirm('åˆªé™¤ï¼Ÿ')){orders.splice(${i},1);save();renderAdmin('orders');}" style="background:red; color:#FFF; font-size:10px;">åˆªé™¤è¨‚å–®</button>
                </div>
            `).join('');
        } else {
            container.innerHTML = `<button onclick="addProd()">ï¼‹æ–°å¢å•†å“</button>` + products.map((p, i) => `
                <div style="padding:10px; border-bottom:1px solid #EEE;">${p.n} (é™é¡:${p.l}) <button onclick="editProd(${i})">æ”¹</button></div>
            `).join('');
        }
    }

    function toggleForce(orderIdx, itemIdx, val) {
        orders[orderIdx].items[itemIdx].forceOk = val;
        save();
        // å­˜æª”å¾Œä¸é‡æ–°åˆ·é é¢ï¼Œä»¥å… checkbox é–ƒçˆ
    }

    function openSearch() { document.getElementById('search-modal').style.display='flex'; }
    function closeSearch() { document.getElementById('search-modal').style.display='none'; }
    window.onload = goHall;
</script>
</body>
</html>
