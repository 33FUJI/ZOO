<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>33æ—¥æœ¬å‹•ç‰©åœ’ - åœ’é•·å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --matcha: #606C38; --rice: #FEF9EF; --caramel: #BC6C25; --earth: #283618; }
        body { background: #f0f0f0; margin: 0; font-family: sans-serif; display: flex; justify-content: center; min-height: 100dvh; }
        
        .app-container { width: 100%; max-width: 1000px; background: var(--rice); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 15px rgba(0,0,0,0.1); height: 100dvh; }

        /* å¤§å»³å¡ç‰‡è‡ªå‹•é€£å‹•æ¨£å¼ */
        .hall { position: absolute; inset: 0; background: var(--rice); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 90%; max-width: 800px; margin-top: 20px; }
        .card { background: #FFF; border: 2px solid #D1C7A1; border-radius: 12px; padding: 25px 10px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card:hover { border-color: var(--caramel); transform: translateY(-3px); }
        .card b { font-size: 16px; color: var(--earth); }

        /* å•†å“åˆ—è¡¨ */
        .container { display: flex; flex: 1; flex-direction: column; overflow: hidden; visibility: hidden; }
        .list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; align-content: flex-start; }
        @media (max-width: 600px) { .list { grid-template-columns: 1fr; } .cart-panel { flex-direction: column; align-items: stretch !important; } .cart-ctrl { width: 100%; } }

        .prod-card { background: #FFF; border-radius: 10px; padding: 15px; border: 1px solid #EEE; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prod-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; display: block; padding-right: 70px; }
        .prod-price { color: var(--caramel); font-size: 18px; font-weight: bold; position: absolute; top: 15px; right: 15px; }
        
        .spec-wrap { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .spec-btn { border: 1px solid #DDD; padding: 6px 12px; border-radius: 6px; background: #FFF; font-size: 14px; cursor: pointer; }
        .spec-btn.active { background: var(--matcha); color: #FFF; border-color: var(--matcha); }
        
        .row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .qty-box { display: flex; border: 1px solid #DDD; border-radius: 6px; height: 38px; background: #FFF; overflow: hidden; }
        .qty-box button { width: 40px; border: none; background: #f9f9f9; font-size: 20px; cursor: pointer; }
        .qty-box span { width: 45px; text-align: center; line-height: 38px; font-weight: bold; }
        .add-btn { flex: 1; background: var(--matcha); color: white; border: none; height: 38px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .cart-panel { background: #FFF; border-top: 2px solid var(--matcha); padding: 15px; display: flex; gap: 20px; align-items: flex-end; }
        #cart-items { flex: 1; max-height: 120px; overflow-y: auto; font-size: 14px; border: 1px inset #f0f0f0; padding: 5px; }
        .cart-ctrl { min-width: 200px; }

        /* å¾Œå° */
        #admin { position: absolute; inset: 0; background: #FFF; z-index: 200; display: none; flex-direction: column; }
        .admin-nav { background: var(--earth); display: flex; overflow-x: auto; }
        .admin-nav button { flex: 1; color: #EEE; padding: 15px; border: none; background: none; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .admin-nav button.active { background: #3d5225; font-weight: bold; color: #FFF; }
        .admin-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        .admin-input { padding: 10px; border: 1px solid #DDD; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .order-box { border: 1px solid #EEE; padding: 15px; border-radius: 10px; margin-bottom: 12px; background: #FAFAFA; border-left: 5px solid var(--matcha); }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 20px; }
        th, td { border: 1px solid #EEE; padding: 10px; text-align: left; }
        th { background: var(--matcha); color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="hall-screen" class="hall">
        <h1 style="color:var(--matcha);">33 æ—¥æœ¬å‹•ç‰©åœ’</h1>
        <button onclick="openQuery()" style="background:var(--caramel); color:white; border:none; padding:15px 40px; border-radius:30px; font-weight:bold; font-size: 16px; cursor:pointer; margin-bottom: 20px;">ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚å–®</button>
        <div id="hall-grid" class="grid"></div>
        <div onclick="adminLogin()" style="margin-top:auto; padding-bottom: 20px; color:#DDD; cursor:pointer; font-size:12px;">ADMIN</div>
    </div>

    <div id="main-app" class="container">
        <div id="prod-list" class="list"></div>
        <div class="cart-panel">
            <div id="cart-items">æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
            <div class="cart-ctrl">
                <p style="margin:5px 0;">ç¸½è¨ˆé‡‘é¡: <b style="color:var(--caramel); font-size:22px;">$ <span id="cart-total">0</span></b></p>
                <input id="nick" style="width:100%; padding:12px; border:1px solid #DDD; border-radius:6px; box-sizing:border-box; margin-bottom: 10px;" placeholder="LINE æš±ç¨±">
                <button onclick="submitOrder()" style="width:100%; padding:14px; background:var(--caramel); color:white; border:none; border-radius:6px; font-weight:bold; font-size: 16px; cursor:pointer;">ç¢ºèªæäº¤è¨‚å–®</button>
                <button onclick="location.reload()" style="width:100%; margin-top:10px; background:none; border:none; color:#999; font-size:13px; cursor:pointer;">â† è¿”å›å¤§å»³</button>
            </div>
        </div>
    </div>

    <div id="admin">
        <div class="admin-nav">
            <button id="tab1" class="active" onclick="tk(1)">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
            <button id="tab2" onclick="tk(2)">ğŸ·ï¸ å•†å“/åˆ†é¡ç®¡ç†</button>
            <button onclick="document.getElementById('admin').style.display='none'">âŒ é€€å‡º</button>
        </div>
        <div class="admin-body">
            <div id="sec-1">
                <div id="summary-report"></div>
                <div id="active-orders"></div>
                <div id="done-orders" style="opacity:0.5; margin-top:30px;"></div>
            </div>
            <div id="sec-2" style="display:none">
                <div style="background:#FDFCF0; padding:20px; border:2px solid #D1C7A1; border-radius:12px; margin-bottom:25px;">
                    <b style="font-size:18px;">â• ä¸Šæ¶å•†å“ (å¯è‡ªç”±è¼¸å…¥åˆ†é¡)</b><br><br>
                    <input id="add-e" class="admin-input" style="width:100%; margin-bottom:10px;" placeholder="åˆ†é¡åç¨± (å¦‚: æ—¥æœ¬è¶…å¸‚ã€è—¥å¦ã€é€£ç·šA...)">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input id="add-n" class="admin-input" style="flex:2" placeholder="å•†å“åç¨±"> 
                        <input id="add-p" class="admin-input" style="width:100px" type="number" placeholder="åƒ¹æ ¼">
                    </div>
                    <input id="add-s" class="admin-input" style="width:100%; margin-bottom:15px;" placeholder="è¦æ ¼æ¸…å–® (å¦‚: M,L æˆ– ç‰¹,èµ«,æµ·)">
                    <button onclick="addProd()" style="width:100%; background:var(--matcha); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">ç™¼å¸ƒå•†å“</button>
                </div>
                <div id="admin-prod-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD7KmXt_PjFzyYKz4tXGQAmz_wvmmSjAm4",
        authDomain: "zoo-62638.firebaseapp.com",
        databaseURL: "https://zoo-62638-default-rtdb.firebaseio.com",
        projectId: "zoo-62638",
        storageBucket: "zoo-62638.firebasestorage.app",
        messagingSenderId: "33012710753",
        appId: "1:33012710753:web:318636add1f5ac2f7b5920"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let productsMap = {}, cart = [], curS = {}, curQty = {};

    db.ref('products').on('value', snap => {
        productsMap = snap.val() || {};
        renderHall();
        renderAdmin();
    });

    // å¤§å»³é€£å‹•æ ¸å¿ƒï¼šè‡ªå‹•å¾æ‰€æœ‰å•†å“ä¸­æå–ä¸é‡è¤‡çš„åˆ†é¡
    function renderHall() {
        const prods = Object.values(productsMap);
        const categories = [...new Set(prods.map(p => p.e))].filter(e => e); 
        document.getElementById('hall-grid').innerHTML = categories.map(e => 
            `<div class="card" onclick="openShop('${e}')"><b>${e}</b></div>`
        ).join('');
    }

    function openShop(e) {
        document.getElementById('hall-screen').style.display = 'none';
        document.getElementById('main-app').style.visibility = 'visible';
        let h = `<h3 style="grid-column: 1/-1; color:var(--matcha); margin:10px 5px;">ğŸ“ ${e}</h3>`;
        for(let id in productsMap) {
            const p = productsMap[id];
            if(p.e !== e) continue;
            if(!curQty[id]) curQty[id] = 1;
            h += `<div class="prod-card">
                <span class="prod-price">$${p.p}</span><b class="prod-title">${p.n}</b>
                <div class="spec-wrap">${p.s ? p.s.split(',').map(v=>`<button class="spec-btn" id="s-${id}-${v}" onclick="setS('${id}','${v}')">${v}</button>`).join('') : ''}</div>
                <div class="row">
                    <div class="qty-box"><button onclick="chgQ('${id}',-1)">-</button><span id="q-${id}">${curQty[id]}</span><button onclick="chgQ('${id}',1)">+</button></div>
                    <button class="add-btn" onclick="add('${id}')">åŠ å…¥è³¼ç‰©è»Š</button>
                </div>
            </div>`;
        }
        document.getElementById('prod-list').innerHTML = h;
    }

    function chgQ(id, d) { curQty[id] = Math.max(1, (curQty[id] || 1) + d); document.getElementById(`q-${id}`).innerText = curQty[id]; }
    function setS(id, v) { 
        curS[id] = v; 
        const btns = document.querySelectorAll(`[id^="s-${id}-"]`);
        btns.forEach(b => b.classList.remove('active'));
        document.getElementById(`s-${id}-${v}`).classList.add('active');
    }

    function add(id) {
        const p = productsMap[id];
        if (p.s && !curS[id]) return alert("è«‹é¸è¦æ ¼ï¼");
        cart.push({...p, sel: curS[id] || "ä¸€èˆ¬", qty: curQty[id], tP: p.p * curQty[id]});
        renderCart();
    }

    function renderCart() {
        let t = 0;
        if(cart.length === 0) document.getElementById('cart-items').innerText = "æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„";
        else {
            document.getElementById('cart-items').innerHTML = cart.map((it, i) => {
                t += it.tP;
                return `<div style="padding:8px 0; border-bottom:1px solid #f0f0f0;">${it.n}(${it.sel}) x${it.qty} <span style="float:right;">$${it.tP} <i onclick="cart.splice(${i},1);renderCart()" style="cursor:pointer; color:#ccc; font-style:normal; margin-left:8px;">âœ•</i></span></div>`;
            }).join('');
        }
        document.getElementById('cart-total').innerText = t;
    }

    function submitOrder() {
        const n = document.getElementById('nick').value.trim();
        if (!n || cart.length === 0) return alert("è«‹å¡«å¯«æš±ç¨±åŠé¸è³¼å•†å“ï¼");
        db.ref('orders').push({ nick: n, items: cart, total: cart.reduce((a,b)=>a+b.tP,0), status: "å¾…å‡ºè²¨", note: "", time: new Date().toLocaleString() });
        alert("ä¸‹å–®æˆåŠŸï¼"); location.reload();
    }

    // --- å¾Œå°ç®¡ç† ---
    function adminLogin() { if(prompt("åœ’é•·å¯†ç¢¼")==="1239") { document.getElementById('admin').style.display='flex'; loadAdminData(); } }
    function tk(idx) { [1,2].forEach(i => { document.getElementById('sec-'+i).style.display = i===idx?'block':'none'; document.getElementById('tab'+i).className = i===idx?'active':''; }); }

    function loadAdminData() {
        db.ref('orders').on('value', snap => {
            const data = snap.val();
            let activeH = "<h3>ğŸ“œ å¾…è™•ç†è¨‚å–®</h3>", doneH = "<h3>âœ… å·²å‡ºè²¨ç´€éŒ„</h3>", sum = {};
            if(!data) { document.getElementById('active-orders').innerHTML = "ç›®å‰å°šç„¡è¨‚å–®"; return; }
            for(let k in data) {
                const o = data[k];
                const h = `<div class="order-box">
                    <b>ğŸ‘¤ ${o.nick}</b> <small style="color:#999;">${o.time}</small>
                    <button onclick="if(confirm('åˆªé™¤ï¼Ÿ')) db.ref('orders/${k}').remove()" style="float:right; border:none; background:none; color:red; cursor:pointer;">[åˆª]</button>
                    <div style="margin:10px 0;">${o.items.map(i=>`â€¢ ${i.n}(${i.sel}) x${i.qty}`).join('<br>')}</div>
                    <div style="font-weight:bold; color:var(--caramel);">ç¸½é¡: $${o.total}</div>
                    <div style="margin-top:10px; border-top:1px solid #EEE; padding-top:10px; display:flex; gap:10px;">
                        <select onchange="db.ref('orders/${k}').update({status:this.value})"><option ${o.status==='å¾…å‡ºè²¨'?'selected':''}>å¾…å‡ºè²¨</option><option ${o.status==='å·²å‡ºè²¨'?'selected':''}>å·²å‡ºè²¨</option></select>
                        <input class="admin-input" style="flex:1" value="${o.note||''}" placeholder="åœ’é•·å‚™è¨»" onchange="db.ref('orders/${k}').update({note:this.value})">
                    </div>
                </div>`;
                if(o.status === 'å·²å‡ºè²¨') doneH += h; else activeH += h;
                if(o.status !== 'å·²å‡ºè²¨') o.items.forEach(i => { let key = `${i.n} [${i.sel}]`; sum[key] = (sum[key] || 0) + i.qty; });
            }
            document.getElementById('active-orders').innerHTML = activeH;
            document.getElementById('done-orders').innerHTML = doneH;
            let sH = `<h3>ğŸ“Š æ¡è³¼ç¸½éœ€æ±‚</h3><table><tr><th>å“é …è¦æ ¼</th><th>ç¸½æ•¸</th></tr>`;
            for(let k in sum) sH += `<tr><td>${k}</td><td style="text-align:center;"><b>${sum[k]}</b></td></tr>`;
            document.getElementById('summary-report').innerHTML = sH + "</table>";
        });
    }

    function renderAdmin() {
        let h = "<h3>ğŸ·ï¸ ç¾æœ‰å•†å“åˆ—è¡¨ (é»æ“Šå¯ç›´æ¥ä¿®æ”¹)</h3>";
        for(let id in productsMap) {
            const p = productsMap[id];
            h += `<div style="padding:12px; border:1px solid #EEE; border-radius:8px; margin-bottom:8px; background:#FFF;">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input class="admin-input" style="width:100px; background:#EEE;" value="${p.e}" placeholder="åˆ†é¡" onchange="db.ref('products/${id}').update({e:this.value})">
                    <input class="admin-input" style="flex:2" value="${p.n}" placeholder="å“å" onchange="db.ref('products/${id}').update({n:this.value})">
                    <input class="admin-input" style="width:70px" type="number" value="${p.p}" onchange="db.ref('products/${id}').update({p:parseInt(this.value)})">
                </div>
                <div style="display:flex; gap:5px;">
                    <input class="admin-input" style="flex:1" value="${p.s||''}" placeholder="è¦æ ¼" onchange="db.ref('products/${id}').update({s:this.value})">
                    <button onclick="if(confirm('åˆªé™¤å•†å“ï¼Ÿ')) db.ref('products/${id}').remove()" style="color:red; border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }
        document.getElementById('admin-prod-list').innerHTML = h;
    }

    function addProd() {
        const e = document.getElementById('add-e').value.trim(),
              n = document.getElementById('add-n').value.trim(), 
              p = parseInt(document.getElementById('add-p').value), 
              s = document.getElementById('add-s').value.trim();
        if(e && n && p) { 
            db.ref('products').push({ e, n, p, s: s || "" }); 
            // ä¿ç•™åˆ†é¡åç¨±ï¼Œæ–¹ä¾¿é€£çºŒä¸Šæ¶åŒä¸€åˆ†é¡å•†å“
            document.getElementById('add-n').value=''; 
            document.getElementById('add-p').value=''; 
            document.getElementById('add-s').value='';
            alert("å•†å“ä¸Šæ¶æˆåŠŸï¼Œåˆ†é¡å·²é€£å‹•ï¼");
        } else { alert("åˆ†é¡ã€å“åè·Ÿåƒ¹æ ¼éƒ½è¦å¡«å–”ï¼"); }
    }

    function openQuery() {
        const n = prompt("è¼¸å…¥æ‚¨çš„ LINE æš±ç¨±ï¼š");
        if(!n) return;
        db.ref('orders').orderByChild('nick').equalTo(n).once('value', snap => {
            const d = snap.val();
            let h = `<div style="padding:20px; text-align:center;"><h2 style="color:var(--matcha)">${n} çš„è¨‚å–®ç´€éŒ„</h2>`;
            if(!d) h += "<p>æŸ¥ç„¡è³‡æ–™ã€‚</p>";
            else for(let k in d) h += `<div style="background:#FFF9C4; padding:15px; border-radius:12px; margin-bottom:15px; text-align:left;">
                ${d[k].items.map(i=>`â€¢ ${i.n}(${i.sel}) x${i.qty}`).join('<br>')}
                <div style="margin-top:10px; border-top:1px solid #E6DB74; padding-top:8px;">
                    <b>é‡‘é¡: $${d[k].total}</b> / ç‹€æ…‹: ${d[k].status}<br>
                    ${d[k].note ? `åœ’é•·å›è¦†: ${d[k].note}` : ''}
                </div>
            </div>`;
            h += `<button onclick="location.reload()" style="width:100%; padding:15px; background:var(--matcha); color:white; border:none; border-radius:8px;">è¿”å›å¤§å»³</button></div>`;
            document.getElementById('prod-list').innerHTML = h;
            document.getElementById('hall-screen').style.display = 'none';
            document.getElementById('main-app').style.visibility = 'visible';
        });
    }
</script>
</body>
</html>
